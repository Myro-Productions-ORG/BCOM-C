<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BCOM-C — Monitor</title>
<script>
  (function(){
    var t=localStorage.getItem("bcom-theme")||"dark";
    document.documentElement.setAttribute("data-theme",t);
    try { var raw=localStorage.getItem("bcom-theme-vars"); if(raw){ var vars=JSON.parse(raw); Object.keys(vars).forEach(function(k){ document.documentElement.style.setProperty(k,vars[k]); }); } } catch(_) {}
  })();
</script>
<link rel="stylesheet" href="../assets/css/bcom.css?v=3" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  /* ── Node cards ─────────────────────────────────── */
  .mon-node-row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
  .mon-node-card {
    flex: 1 1 300px;
    background: #0a0704;
    border: 1px solid #1a0e06;
    padding: 14px 16px;
  }
  .mon-node-hdr {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .mon-node-name { font-size:11px; letter-spacing:2px; color:var(--orange-dark); font-weight:600; }
  .mon-status-pill {
    font-size:9px; letter-spacing:1.5px; padding:2px 8px; border:1px solid;
  }
  .mon-status-pill.online  { color:#27ae60; border-color:#27ae60; }
  .mon-status-pill.offline { color:#e74c3c; border-color:#e74c3c; }
  .mon-status-pill.unknown { color:#555;    border-color:#444; }

  .mon-metrics { display:flex; flex-direction:column; gap:8px; }
  .mon-metric { display:flex; flex-direction:column; gap:3px; }
  .mon-metric-hdr { display:flex; justify-content:space-between; font-size:10px; }
  .mon-metric-key { color:#444; letter-spacing:1px; }
  .mon-metric-val { color:var(--text-primary); font-variant-numeric:tabular-nums; }
  .mon-bar-track { background:#0e0a06; height:4px; }
  .mon-bar-fill  { height:4px; background:var(--orange-dark); transition:width .5s; }
  .mon-bar-fill.warn   { background:#f39c12; }
  .mon-bar-fill.crit   { background:#e74c3c; }

  /* ── Sparkline ring ─────────────────────────────── */
  .mon-spark-wrap { position:relative; height:60px; margin-top:8px; }
  .mon-spark-wrap canvas { max-height:60px; }

  /* ── Services table ─────────────────────────────── */
  .mon-svc-table { width:100%; border-collapse:collapse; font-size:11px; }
  .mon-svc-table th { font-size:9px; letter-spacing:1.5px; color:#444; padding:6px 8px; border-bottom:1px solid #150d05; text-align:left; }
  .mon-svc-table td { padding:7px 8px; border-bottom:1px solid #0e0804; color:var(--text-primary); }
  .mon-svc-table tr:hover td { background:#0e0804; }
  .svc-pill { font-size:9px; letter-spacing:1px; padding:2px 7px; border:1px solid; display:inline-block; }
  .svc-pill.running { color:#27ae60; border-color:#27ae60; }
  .svc-pill.stopped { color:#e74c3c; border-color:#e74c3c; }
  .svc-pill.unknown { color:#555;    border-color:#444; }
  .svc-action-btn {
    background:none; border:1px solid #1a0e06; color:#666; padding:2px 8px;
    font-size:9px; letter-spacing:1px; cursor:pointer; font-family:inherit;
  }
  .svc-action-btn:hover { border-color:var(--orange-dark); color:var(--orange-dark); }

  /* ── Containers table ───────────────────────────── */
  .mon-ct-table { width:100%; border-collapse:collapse; font-size:11px; }
  .mon-ct-table th { font-size:9px; letter-spacing:1.5px; color:#444; padding:6px 8px; border-bottom:1px solid #150d05; text-align:left; }
  .mon-ct-table td { padding:7px 8px; border-bottom:1px solid #0e0804; color:var(--text-primary); white-space:nowrap; }
  .mon-ct-table tr:hover td { background:#0e0804; }
  .ct-name { color:var(--orange-dark); font-size:10px; letter-spacing:0.5px; }
  .ct-status { font-size:9px; letter-spacing:1px; padding:2px 7px; border:1px solid; display:inline-block; }
  .ct-status.running { color:#27ae60; border-color:#27ae60; }
  .ct-status.exited  { color:#e74c3c; border-color:#e74c3c; }
  .ct-status.paused  { color:#f39c12; border-color:#f39c12; }
  .ct-ctrl { display:flex; gap:4px; }

  /* ── Storage bars ───────────────────────────────── */
  .mon-stor-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:4px; }
  .mon-stor-item { flex:1 1 200px; }
  .mon-stor-hdr { display:flex; justify-content:space-between; font-size:10px; margin-bottom:4px; }
  .mon-stor-label { color:#666; letter-spacing:1px; }
  .mon-stor-val   { color:var(--text-primary); font-variant-numeric:tabular-nums; }
  .mon-stor-track { background:#0e0a06; height:6px; border:1px solid #150d05; }
  .mon-stor-fill  { height:100%; background:var(--orange-dark); transition:width .5s; }
  .mon-stor-fill.warn { background:#f39c12; }
  .mon-stor-fill.crit { background:#e74c3c; }

  /* ── Metrics summary ────────────────────────────── */
  .mon-metrics-chips { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:4px; }
  .mon-m-chip { background:#080604; border:1px solid #150d05; padding:8px 14px; }
  .mon-m-chip-label { font-size:9px; letter-spacing:1.5px; color:#444; }
  .mon-m-chip-val   { font-size:16px; color:var(--orange-dark); font-variant-numeric:tabular-nums; }
  .mon-empty { color:#333; font-size:11px; letter-spacing:1.5px; padding:16px; text-align:center; }
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-title">BCOM-C</div>
  <div class="topbar-right">
    <a class="nav-btn" href="../index.html">DASHBOARD</a>
    <a class="nav-btn" href="data-gen.html">DATA GEN</a>
    <a class="nav-btn" href="pipeline.html">PIPELINE</a>
    <a class="nav-btn" href="resources.html">RESOURCES</a>
    <a class="nav-btn" href="reports.html">REPORTS</a>
    <a class="nav-btn" href="orchestrator.html">ORCHESTRATOR</a>
    <a class="cog-btn" href="settings.html" title="Settings">⚙</a>
    <div class="timestamp"><span id="clock">--:--:--</span>&nbsp;&nbsp;<span id="datestamp">----/--/--</span></div>
  </div>
</div>

<main class="bcom-main">

  <!-- Node health cards -->
  <div class="mon-node-row">
    <!-- SPARK-BOB -->
    <div class="mon-node-card">
      <div class="mon-node-hdr">
        <span class="mon-node-name">SPARK-BOB</span>
        <span class="mon-status-pill unknown" id="spark-status-pill">CHECKING…</span>
      </div>
      <div class="mon-metrics" id="spark-metrics">
        <div class="mon-empty">LOADING…</div>
      </div>
    </div>
    <!-- LINUX-DSKTP -->
    <div class="mon-node-card">
      <div class="mon-node-hdr">
        <span class="mon-node-name">LINUX-DSKTP</span>
        <span class="mon-status-pill unknown" id="linux-status-pill">CHECKING…</span>
      </div>
      <div class="mon-metrics" id="linux-metrics">
        <div class="mon-empty">LOADING…</div>
      </div>
    </div>
  </div>

  <!-- Storage -->
  <div class="section-panel" style="margin-bottom:12px">
    <div class="section-hdr">
      <span class="section-title">STORAGE</span>
      <span class="section-meta" id="stor-updated">—</span>
    </div>
    <div id="stor-body"><div class="mon-empty">LOADING…</div></div>
  </div>

  <!-- API Metrics summary -->
  <div class="section-panel" style="margin-bottom:12px">
    <div class="section-hdr">
      <span class="section-title">API METRICS</span>
      <span class="section-meta" id="metrics-updated">—</span>
    </div>
    <div class="mon-metrics-chips" id="metrics-chips">
      <div class="mon-empty">LOADING…</div>
    </div>
  </div>

  <!-- Services -->
  <div class="section-panel" style="margin-bottom:12px">
    <div class="section-hdr">
      <span class="section-title">SERVICES</span>
      <span class="section-meta" id="svc-count">—</span>
    </div>
    <div style="overflow-x:auto">
      <table class="mon-svc-table">
        <thead><tr><th>NAME</th><th>STATUS</th><th>PID</th><th>UPTIME</th><th>CPU%</th><th>MEM</th><th>ACTIONS</th></tr></thead>
        <tbody id="svc-tbody"><tr><td colspan="7" class="mon-empty">LOADING…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Containers -->
  <div class="section-panel">
    <div class="section-hdr">
      <span class="section-title">CONTAINERS</span>
      <span class="section-meta" id="ct-count">—</span>
    </div>
    <div style="overflow-x:auto">
      <table class="mon-ct-table">
        <thead><tr><th>NAME</th><th>IMAGE</th><th>STATUS</th><th>PORTS</th><th>CPU%</th><th>MEM</th><th>ACTIONS</th></tr></thead>
        <tbody id="ct-tbody"><tr><td colspan="7" class="mon-empty">LOADING…</td></tr></tbody>
      </table>
    </div>
  </div>

</main>

<script src="../assets/js/bcom.js?v=5"></script>
<script>
(function(){
  'use strict';

  function pct(n){ return Math.min(100, Math.max(0, parseFloat(n)||0)); }
  function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function fmtBytes(b){
    if (b == null) return '—';
    if (b >= 1e12) return (b/1e12).toFixed(1)+'TB';
    if (b >= 1e9)  return (b/1e9).toFixed(1)+'GB';
    if (b >= 1e6)  return (b/1e6).toFixed(1)+'MB';
    return b+'B';
  }
  function barClass(p){ return p >= 90 ? ' crit' : p >= 70 ? ' warn' : ''; }

  /* ── Metric bar ────────────────────────────────────────── */
  function metricBar(label, val, unit, p){
    p = pct(p);
    return '<div class="mon-metric">' +
      '<div class="mon-metric-hdr">' +
        '<span class="mon-metric-key">' + label + '</span>' +
        '<span class="mon-metric-val">' + escHtml(String(val||'—')) + (unit?' '+unit:'') + '</span>' +
      '</div>' +
      '<div class="mon-bar-track"><div class="mon-bar-fill' + barClass(p) + '" style="width:' + p + '%"></div></div>' +
    '</div>';
  }

  /* ── Apply SPARK stats ──────────────────────────────────── */
  function applySparkStats(d){
    var pill = document.getElementById('spark-status-pill');
    pill.textContent = 'ONLINE'; pill.className = 'mon-status-pill online';

    var html = '';
    var cpu  = d.cpu_percent||d.cpu||0;
    var ram  = d.memory_percent||d.ram_percent||0;
    var ramU = d.memory_used||d.ram_used;
    var ramT = d.memory_total||d.ram_total;
    html += metricBar('CPU', cpu.toFixed(1), '%', cpu);
    html += metricBar('RAM', (ramU!=null?fmtBytes(ramU)+(ramT?'/'+fmtBytes(ramT):''):ram.toFixed(1)+'%'), '', ram);

    /* GPU */
    var gpus = d.gpus||d.gpu||[];
    if (!Array.isArray(gpus)) gpus = [gpus];
    gpus.forEach(function(g, i){
      var gp = g.utilization||g.gpu_percent||0;
      var vp = g.memory_percent||g.vram_percent||(g.memory_used&&g.memory_total?Math.round(g.memory_used/g.memory_total*100):0);
      var vU = g.memory_used; var vT = g.memory_total;
      html += metricBar('GPU '+(gpus.length>1?i+' ':'')+'UTIL', gp.toFixed(1), '%', gp);
      html += metricBar('GPU '+(gpus.length>1?i+' ':'')+'VRAM', vU!=null?fmtBytes(vU)+(vT?'/'+fmtBytes(vT):''):vp.toFixed(1)+'%', '', vp);
    });

    /* Temp */
    if (d.temperature||d.temp) html += metricBar('TEMP', (d.temperature||d.temp).toFixed(1), '°C', ((d.temperature||d.temp)-40)/50*100);

    document.getElementById('spark-metrics').innerHTML = html;
  }
  function setSparkOffline(){ var p=document.getElementById('spark-status-pill'); p.textContent='OFFLINE'; p.className='mon-status-pill offline'; document.getElementById('spark-metrics').innerHTML='<div class="mon-empty">NODE OFFLINE</div>'; }

  /* ── Apply LINUX stats ──────────────────────────────────── */
  function applyLinuxStats(d){
    var pill = document.getElementById('linux-status-pill');
    pill.textContent = 'ONLINE'; pill.className = 'mon-status-pill online';

    var html = '';
    var cpu = d.cpu_percent||d.cpu||0;
    var ram = d.memory_percent||d.ram_percent||0;
    var ramU = d.memory_used||d.ram_used;
    var ramT = d.memory_total||d.ram_total;
    html += metricBar('CPU', cpu.toFixed(1), '%', cpu);
    html += metricBar('RAM', ramU!=null?fmtBytes(ramU)+(ramT?'/'+fmtBytes(ramT):''):ram.toFixed(1)+'%', '', ram);
    if (d.disk_percent||d.disk) html += metricBar('DISK', (d.disk_percent||d.disk).toFixed(1), '%', d.disk_percent||d.disk);

    document.getElementById('linux-metrics').innerHTML = html;
  }
  function setLinuxOffline(){ var p=document.getElementById('linux-status-pill'); p.textContent='OFFLINE'; p.className='mon-status-pill offline'; document.getElementById('linux-metrics').innerHTML='<div class="mon-empty">NODE OFFLINE</div>'; }

  /* ── Storage ────────────────────────────────────────────── */
  function applyStorage(d){
    var mounts = Array.isArray(d) ? d : (d.mounts||d.disks||d.volumes||[]);
    if (!mounts.length) { document.getElementById('stor-body').innerHTML='<div class="mon-empty">NO STORAGE DATA</div>'; return; }
    var html = '<div class="mon-stor-row">';
    mounts.forEach(function(m){
      var used  = m.used||m.used_bytes||0;
      var total = m.total||m.total_bytes||0;
      var p     = total ? Math.round(used/total*100) : (m.percent||m.use_pct||0);
      var label = m.mountpoint||m.mount||m.name||m.device||'?';
      html += '<div class="mon-stor-item">';
      html += '<div class="mon-stor-hdr"><span class="mon-stor-label">' + escHtml(label) + '</span><span class="mon-stor-val">' + fmtBytes(used) + ' / ' + fmtBytes(total) + ' (' + Math.round(p) + '%)</span></div>';
      html += '<div class="mon-stor-track"><div class="mon-stor-fill' + barClass(p) + '" style="width:' + Math.min(100,p) + '%"></div></div>';
      html += '</div>';
    });
    html += '</div>';
    document.getElementById('stor-body').innerHTML = html;
    document.getElementById('stor-updated').textContent = new Date().toLocaleTimeString();
  }

  /* ── API Metrics ────────────────────────────────────────── */
  function applyMetrics(d){
    var keys = ['requests_total','requests_per_sec','avg_latency_ms','active_connections','errors_total'];
    var labels = ['REQUESTS TOTAL','REQ/S','AVG LATENCY','ACTIVE CONN','ERRORS'];
    var html = '';
    keys.forEach(function(k,i){
      var v = d[k];
      if (v == null) { /* try prometheus-style */
        var alt = k.replace(/_/g,'.');
        v = d[alt];
      }
      if (v == null) return;
      html += '<div class="mon-m-chip">' +
        '<div class="mon-m-chip-label">' + labels[i] + '</div>' +
        '<div class="mon-m-chip-val">' + (typeof v==='number'&&v>1000?fmtBytes(v):String(v)) + '</div>' +
        '</div>';
    });
    if (!html) html = '<div class="mon-empty">NO METRICS DATA</div>';
    document.getElementById('metrics-chips').innerHTML = html;
    document.getElementById('metrics-updated').textContent = new Date().toLocaleTimeString();
  }

  /* ── Services ───────────────────────────────────────────── */
  function applyServices(data){
    var svcs = Array.isArray(data) ? data : (data.services||data.items||[]);
    document.getElementById('svc-count').textContent = svcs.length + ' SERVICES';
    if (!svcs.length) { document.getElementById('svc-tbody').innerHTML='<tr><td colspan="7" class="mon-empty">NO SERVICES</td></tr>'; return; }
    document.getElementById('svc-tbody').innerHTML = svcs.map(function(s){
      var st = (s.status||s.state||'unknown').toLowerCase();
      var stClass = st==='running'?'running':st==='stopped'?'stopped':'unknown';
      return '<tr>' +
        '<td class="ct-name">' + escHtml(s.name||'?') + '</td>' +
        '<td><span class="svc-pill ' + stClass + '">' + st.toUpperCase() + '</span></td>' +
        '<td style="color:#555">' + escHtml(String(s.pid||'—')) + '</td>' +
        '<td style="color:#555">' + escHtml(s.uptime||s.since||'—') + '</td>' +
        '<td>' + escHtml(String(s.cpu_percent||s.cpu||'—')) + '</td>' +
        '<td>' + escHtml(String(s.memory||s.mem||'—')) + '</td>' +
        '<td><div style="display:flex;gap:4px">' +
          '<button class="svc-action-btn" onclick="svcAction(\'' + escHtml(s.name) + '\',\'restart\')">RESTART</button>' +
          (st==='running'
            ? '<button class="svc-action-btn" onclick="svcAction(\'' + escHtml(s.name) + '\',\'stop\')">STOP</button>'
            : '<button class="svc-action-btn" onclick="svcAction(\'' + escHtml(s.name) + '\',\'start\')">START</button>') +
        '</div></td>' +
      '</tr>';
    }).join('');
  }

  window.svcAction = function(name, action){
    fetch('/api/system/services/' + encodeURIComponent(name) + '/' + action, { method:'POST', cache:'no-store' })
      .then(function(r){ return r.ok ? r.json() : null; })
      .then(function(){ setTimeout(pollServices, 1500); })
      .catch(function(){});
  };

  /* ── Containers ─────────────────────────────────────────── */
  function applyContainers(data){
    var cts = Array.isArray(data) ? data : (data.containers||data.items||[]);
    document.getElementById('ct-count').textContent = cts.length + ' CONTAINERS';
    if (!cts.length) { document.getElementById('ct-tbody').innerHTML='<tr><td colspan="7" class="mon-empty">NO CONTAINERS</td></tr>'; return; }
    document.getElementById('ct-tbody').innerHTML = cts.map(function(c){
      var st = (c.status||c.state||'unknown').toLowerCase();
      var stClass = st.indexOf('run')!==-1?'running':st.indexOf('exit')!==-1?'exited':st.indexOf('paus')!==-1?'paused':'unknown';
      var id = c.id||c.container_id||'';
      var ports = Array.isArray(c.ports) ? c.ports.join(', ') : (c.ports||'—');
      return '<tr>' +
        '<td class="ct-name">' + escHtml(c.name||id.slice(0,12)) + '</td>' +
        '<td style="color:#555;font-size:10px">' + escHtml((c.image||'?').split(':')[0].replace(/^.+\//,'')) + '</td>' +
        '<td><span class="ct-status ' + stClass + '">' + st.toUpperCase().slice(0,8) + '</span></td>' +
        '<td style="color:#555;font-size:10px">' + escHtml(String(ports).slice(0,30)) + '</td>' +
        '<td>' + escHtml(String(c.cpu_percent||c.cpu||'—')) + '</td>' +
        '<td>' + escHtml(String(c.memory||c.mem_usage||'—')) + '</td>' +
        '<td><div class="ct-ctrl">' +
          '<button class="svc-action-btn" onclick="ctAction(\'' + escHtml(id) + '\',\'restart\')">↺</button>' +
          (stClass==='running'
            ? '<button class="svc-action-btn" onclick="ctAction(\'' + escHtml(id) + '\',\'stop\')">■</button>'
            : '<button class="svc-action-btn" onclick="ctAction(\'' + escHtml(id) + '\',\'start\')">▶</button>') +
        '</div></td>' +
      '</tr>';
    }).join('');
  }

  window.ctAction = function(id, action){
    fetch('/api/containers/' + encodeURIComponent(id) + '/' + action, { method:'POST', cache:'no-store' })
      .then(function(){ setTimeout(pollContainers, 2000); })
      .catch(function(){});
  };

  /* ── Poll functions ─────────────────────────────────────── */
  function pollNodes(){
    fetch('/api/system/stats', { cache:'no-store' })
      .then(function(r){ return r.ok?r.json():null; })
      .then(function(d){ if(d) applySparkStats(d); else setSparkOffline(); })
      .catch(setSparkOffline);
    fetch('/api/system/linux/stats', { cache:'no-store' })
      .then(function(r){ return r.ok?r.json():null; })
      .then(function(d){ if(d) applyLinuxStats(d); else setLinuxOffline(); })
      .catch(setLinuxOffline);
  }

  function pollStorage(){
    fetch('/api/system/storage', { cache:'no-store' })
      .then(function(r){ return r.ok?r.json():null; })
      .then(function(d){ if(d) applyStorage(d); })
      .catch(function(){});
  }

  function pollMetrics(){
    fetch('/api/metrics', { cache:'no-store' })
      .then(function(r){ return r.ok?r.json():null; })
      .then(function(d){ if(d) applyMetrics(d); })
      .catch(function(){});
  }

  function pollServices(){
    fetch('/api/system/services', { cache:'no-store' })
      .then(function(r){ return r.ok?r.json():null; })
      .then(function(d){ if(d) applyServices(d); })
      .catch(function(){});
  }

  function pollContainers(){
    fetch('/api/containers/', { cache:'no-store' })
      .then(function(r){ return r.ok?r.json():null; })
      .then(function(d){ if(d) applyContainers(d); })
      .catch(function(){});
  }

  /* ── Init ───────────────────────────────────────────────── */
  pollNodes(); pollStorage(); pollMetrics(); pollServices(); pollContainers();
  var _nodeT   = setInterval(pollNodes,      6000);
  var _storT   = setInterval(pollStorage,   15000);
  var _metrT   = setInterval(pollMetrics,   10000);
  var _svcT    = setInterval(pollServices,  10000);
  var _ctT     = setInterval(pollContainers, 8000);
  window.addEventListener('beforeunload', function(){
    [_nodeT,_storT,_metrT,_svcT,_ctT].forEach(clearInterval);
  });
})();
</script>
</body>
</html>
