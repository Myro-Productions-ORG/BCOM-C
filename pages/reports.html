<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reports — BCOM-C</title>
<link rel="stylesheet" href="../bcom.css?v=3">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
.rpt-hero{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:24px}
.rpt-chip{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:14px 20px;min-width:130px}
.rpt-chip-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.rpt-chip-val{font-size:26px;font-weight:700;color:var(--fg)}

.rpt-section{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:20px}
.rpt-section-title{font-size:13px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}

.rpt-table{width:100%;border-collapse:collapse;font-size:12px}
.rpt-table th{text-align:left;font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:8px 10px;border-bottom:1px solid var(--border);cursor:pointer;user-select:none}
.rpt-table th:hover{color:var(--fg)}
.rpt-table td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.04);color:var(--fg);vertical-align:middle}
.rpt-table tr:hover td{background:rgba(255,255,255,.025)}

.pill{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
.pill-pass{background:rgba(40,180,40,.18);color:#6f6}
.pill-fail{background:rgba(220,60,60,.18);color:#f88}
.score-hi{color:#6f6;font-weight:700}
.score-mid{color:var(--orange-dark);font-weight:700}
.score-lo{color:#f88;font-weight:700}

/* Chart grids */
.chart-2col{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
@media(max-width:700px){.chart-2col{grid-template-columns:1fr}}
.chart-wrap{position:relative;height:220px}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:18px}
.chart-card-title{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:12px}

/* Heatmap */
.heatmap-wrap{overflow-x:auto}
.heatmap-table{border-collapse:collapse;font-size:11px}
.heatmap-table th{padding:6px 12px;text-align:center;color:var(--muted);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em}
.heatmap-table td{padding:0;border:1px solid rgba(255,255,255,.04)}
.hm-cell{width:56px;height:36px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600}
.hm-row-label{padding:4px 12px 4px 0;text-align:right;color:var(--muted);font-size:11px;white-space:nowrap}

/* Filter row */
.flt-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.flt-row input,.flt-row select{background:var(--bg);border:1px solid var(--border);color:var(--fg);border-radius:6px;padding:6px 10px;font-size:12px}
.flt-row input{flex:1;min-width:140px}

/* Timeline bars */
.timeline-row{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px}
.timeline-label{width:180px;flex-shrink:0;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:11px}
.timeline-track{flex:1;height:18px;background:rgba(255,255,255,.04);border-radius:3px;overflow:hidden;position:relative}
.timeline-bar{height:100%;border-radius:3px;display:flex;align-items:center;padding:0 6px;font-size:10px;font-weight:600;color:rgba(255,255,255,.7);white-space:nowrap;overflow:hidden;min-width:2px}
</style>
</head>
<body>
<nav class="bcom-nav">
  <a href="../index.html" class="bcom-nav-brand">BCOM-C</a>
  <div class="bcom-nav-links">
    <a href="pipeline.html">PIPELINE</a>
    <a href="data-gen.html">DATAGEN</a>
    <a href="analytics.html">ANALYTICS</a>
    <a href="coordinator.html">COORDINATOR</a>
    <a href="datasets.html">DATASETS</a>
    <a href="evals.html">EVALS</a>
    <a href="models.html">MODELS</a>
    <a href="monitor.html">MONITOR</a>
    <a href="deploy.html">DEPLOY</a>
    <a href="reports.html" class="active">REPORTS</a>
    <a href="resources.html">⚙</a>
  </div>
</nav>

<div class="bcom-page">
  <div class="bcom-page-header">
    <h1 class="bcom-page-title">Reports</h1>
    <div class="bcom-page-actions">
      <span id="rpt-refresh" style="font-size:11px;color:var(--muted)">—</span>
    </div>
  </div>

  <!-- Hero chips — from /api/reports/summary -->
  <div class="rpt-hero">
    <div class="rpt-chip"><div class="rpt-chip-label">Eval Runs</div><div class="rpt-chip-val" id="chip-evals">—</div></div>
    <div class="rpt-chip"><div class="rpt-chip-label">Pipelines</div><div class="rpt-chip-val" id="chip-pipelines">—</div></div>
    <div class="rpt-chip"><div class="rpt-chip-label">Finetunes</div><div class="rpt-chip-val" id="chip-ft">—</div></div>
    <div class="rpt-chip"><div class="rpt-chip-label">Datagen Jobs</div><div class="rpt-chip-val" id="chip-dg">—</div></div>
    <div class="rpt-chip"><div class="rpt-chip-label">Best Score</div><div class="rpt-chip-val" id="chip-best">—</div></div>
    <div class="rpt-chip"><div class="rpt-chip-label">Avg Score</div><div class="rpt-chip-val" id="chip-avg">—</div></div>
  </div>

  <!-- Chart row: Datagen Stats + Finetune History -->
  <div class="chart-2col">
    <div class="chart-card">
      <div class="chart-card-title">Datagen Stats</div>
      <div class="chart-wrap"><canvas id="chart-dg"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-card-title">Finetune Loss History</div>
      <div class="chart-wrap"><canvas id="chart-ft"></canvas></div>
    </div>
  </div>

  <!-- Model Leaderboard — /api/reports/model-leaderboard -->
  <div class="rpt-section">
    <div class="rpt-section-title">
      Model Leaderboard
      <span style="font-size:11px;color:var(--muted);cursor:pointer" onclick="sortLeaderboard()">▼ sort</span>
    </div>
    <div style="overflow-x:auto">
      <table class="rpt-table" id="leaderboard-table">
        <thead><tr>
          <th onclick="sortLB('rank')">#</th>
          <th onclick="sortLB('model')">Model</th>
          <th onclick="sortLB('avg_score')">Avg Score</th>
          <th onclick="sortLB('best_score')">Best</th>
          <th onclick="sortLB('eval_count')">Evals</th>
          <th onclick="sortLB('pass_rate')">Pass Rate</th>
          <th>Status</th>
        </tr></thead>
        <tbody id="lb-tbody"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Eval Comparison — /api/reports/eval-comparison -->
  <div class="rpt-section">
    <div class="rpt-section-title">Eval Comparison</div>
    <div class="flt-row">
      <input id="ec-search" type="text" placeholder="Filter model…" oninput="renderEvalComp()">
      <select id="ec-suite" onchange="renderEvalComp()"><option value="">All Suites</option></select>
    </div>
    <div style="overflow-x:auto">
      <table class="rpt-table">
        <thead><tr><th>Model</th><th>Suite</th><th>Score</th><th>Pass Rate</th><th>Evals</th><th>Trend</th><th>Status</th></tr></thead>
        <tbody id="ec-tbody"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Test Heatmap — /api/reports/test-heatmap -->
  <div class="rpt-section">
    <div class="rpt-section-title">Test Heatmap</div>
    <div class="heatmap-wrap" id="heatmap-wrap">
      <div style="color:var(--muted);font-size:13px">Loading…</div>
    </div>
  </div>

  <!-- Finetune History table — /api/reports/finetune-history -->
  <div class="rpt-section">
    <div class="rpt-section-title">Finetune History</div>
    <div style="overflow-x:auto">
      <table class="rpt-table">
        <thead><tr><th>Run ID</th><th>Model</th><th>Dataset</th><th>Rank</th><th>Epochs</th><th>LR</th><th>Final Loss</th><th>Duration</th><th>Status</th></tr></thead>
        <tbody id="ft-tbody"><tr><td colspan="9" style="text-align:center;color:var(--muted);padding:20px">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Pipeline Timeline — /api/reports/pipeline-timeline -->
  <div class="rpt-section">
    <div class="rpt-section-title">Pipeline Timeline</div>
    <div id="timeline-wrap"><div style="color:var(--muted);font-size:13px">Loading…</div></div>
  </div>

  <!-- Model-Suite Matrix — /api/reports/model-suite-matrix -->
  <div class="rpt-section">
    <div class="rpt-section-title">Model × Suite Matrix</div>
    <div class="heatmap-wrap" id="matrix-wrap">
      <div style="color:var(--muted);font-size:13px">Loading…</div>
    </div>
  </div>
</div>

<script src="../bcom.js?v=5"></script>
<script>
window.BCOM = window.BCOM || {};
BCOM.apiBase = '';

var _lb = [], _lbSort = 'rank', _lbAsc = true;
var _ec = [], _ecSuites = [];
var ORANGE = 'rgba(180,90,20,1)';
var ORANGE_DIM = 'rgba(180,90,20,0.15)';

Chart.defaults.color = '#555';
Chart.defaults.font.family = 'inherit';

function apiFetch(url) {
  return fetch(BCOM.apiBase + url, { cache: 'no-store' }).then(function(r) {
    if (!r.ok) throw new Error(r.status);
    return r.json();
  });
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function sc(n) { return n >= 0.80 ? 'score-hi' : n >= 0.60 ? 'score-mid' : 'score-lo'; }
function scPct(n) { return sc(n / 100); }
function pct(v) { return typeof v === 'number' ? (v > 1 ? v.toFixed(1) + '%' : (v * 100).toFixed(1) + '%') : '—'; }

/* ── Summary ────────────────────────────────────────────── */
function pollSummary() {
  apiFetch('/api/reports/summary').then(function(d) {
    document.getElementById('chip-evals').textContent     = d.eval_runs     || d.evals     || 0;
    document.getElementById('chip-pipelines').textContent = d.pipelines     || d.pipeline_runs || 0;
    document.getElementById('chip-ft').textContent        = d.finetune_jobs || d.finetunes  || 0;
    document.getElementById('chip-dg').textContent        = d.datagen_jobs  || d.datagen   || 0;
    var best = d.best_score;
    var avg  = d.avg_score;
    document.getElementById('chip-best').textContent = best !== undefined ? pct(best) : '—';
    document.getElementById('chip-avg').textContent  = avg  !== undefined ? pct(avg)  : '—';
    document.getElementById('rpt-refresh').textContent = 'updated ' + new Date().toLocaleTimeString();
  }).catch(function(){});
}

/* ── Leaderboard ────────────────────────────────────────── */
function pollLeaderboard() {
  apiFetch('/api/reports/model-leaderboard').then(function(data) {
    _lb = Array.isArray(data) ? data : (data.models || data.leaderboard || data.items || []);
    renderLB();
  }).catch(function() {
    document.getElementById('lb-tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">No data</td></tr>';
  });
}

function sortLB(field) {
  if (_lbSort === field) _lbAsc = !_lbAsc;
  else { _lbSort = field; _lbAsc = field === 'rank'; }
  renderLB();
}

function renderLB() {
  var sorted = _lb.slice().sort(function(a, b) {
    var va = a[_lbSort] !== undefined ? a[_lbSort] : (a.metrics && a.metrics[_lbSort]);
    var vb = b[_lbSort] !== undefined ? b[_lbSort] : (b.metrics && b.metrics[_lbSort]);
    if (va === undefined) va = 0;
    if (vb === undefined) vb = 0;
    return _lbAsc ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
  });

  var tbody = document.getElementById('lb-tbody');
  if (!sorted.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">No data</td></tr>';
    return;
  }
  tbody.innerHTML = sorted.map(function(m, i) {
    var rank  = m.rank !== undefined ? m.rank : (i + 1);
    var model = m.model_id || m.model || m.name || '—';
    var avg   = m.avg_score !== undefined ? m.avg_score : (m.metrics && m.metrics.avg_score);
    var best  = m.best_score !== undefined ? m.best_score : (m.metrics && m.metrics.best_score);
    var cnt   = m.eval_count || m.evals || '—';
    var pass  = m.pass_rate !== undefined ? m.pass_rate : (m.metrics && m.metrics.pass_rate);
    var rankCls = rank === 1 ? 'color:#ffd700' : rank === 2 ? 'color:#c0c0c0' : rank === 3 ? 'color:#cd7f32' : 'color:var(--muted)';
    return '<tr>' +
      '<td style="font-weight:700;' + rankCls + '">' + rank + '</td>' +
      '<td style="font-weight:600">' + esc(model) + '</td>' +
      '<td class="' + sc(avg || 0) + '">' + pct(avg) + '</td>' +
      '<td class="' + sc(best || 0) + '">' + pct(best) + '</td>' +
      '<td>' + esc(String(cnt)) + '</td>' +
      '<td>' + pct(pass) + '</td>' +
      '<td><span class="pill ' + ((avg || 0) >= 0.7 ? 'pill-pass' : 'pill-fail') + '">' + ((avg || 0) >= 0.7 ? 'STRONG' : 'WEAK') + '</span></td>' +
      '</tr>';
  }).join('');
}

/* ── Eval Comparison ────────────────────────────────────── */
function pollEvalComparison() {
  apiFetch('/api/reports/eval-comparison').then(function(data) {
    _ec = Array.isArray(data) ? data : (data.comparisons || data.evals || data.items || []);
    var suites = [...new Set(_ec.map(function(e){ return e.suite || e.suite_id || ''; }).filter(Boolean))];
    _ecSuites = suites;
    var sel = document.getElementById('ec-suite');
    sel.innerHTML = '<option value="">All Suites</option>' + suites.map(function(s){ return '<option value="' + esc(s) + '">' + esc(s) + '</option>'; }).join('');
    renderEvalComp();
  }).catch(function() {
    document.getElementById('ec-tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">No data</td></tr>';
  });
}

window.renderEvalComp = function() {
  var search = (document.getElementById('ec-search').value || '').toLowerCase();
  var suite  = document.getElementById('ec-suite').value;
  var filtered = _ec.filter(function(e) {
    var model = (e.model_id || e.model || '').toLowerCase();
    if (search && model.indexOf(search) < 0) return false;
    if (suite && (e.suite || e.suite_id) !== suite) return false;
    return true;
  });
  var tbody = document.getElementById('ec-tbody');
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">No data</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(function(e) {
    var model = e.model_id || e.model || '—';
    var suite = e.suite || e.suite_id || '—';
    var score = e.score !== undefined ? e.score : e.avg_score;
    var pass  = e.pass_rate !== undefined ? e.pass_rate : e.passrate;
    var cnt   = e.eval_count || e.count || '—';
    var trend = e.trend || e.score_trend;
    var trendHtml = trend > 0 ? '<span style="color:#6f6">▲ +' + trend.toFixed(2) + '</span>' :
                   trend < 0 ? '<span style="color:#f88">▼ ' + trend.toFixed(2) + '</span>' : '—';
    var status = e.status || 'unknown';
    return '<tr>' +
      '<td style="font-weight:600">' + esc(model) + '</td>' +
      '<td style="color:var(--muted)">' + esc(suite) + '</td>' +
      '<td class="' + sc(score || 0) + '">' + pct(score) + '</td>' +
      '<td>' + pct(pass) + '</td>' +
      '<td>' + esc(String(cnt)) + '</td>' +
      '<td>' + trendHtml + '</td>' +
      '<td><span class="pill ' + ((score || 0) >= 0.7 ? 'pill-pass' : 'pill-fail') + '">' + esc(status) + '</span></td>' +
      '</tr>';
  }).join('');
};

/* ── Test Heatmap ───────────────────────────────────────── */
function pollTestHeatmap() {
  apiFetch('/api/reports/test-heatmap').then(function(data) {
    renderHeatmap(data, 'heatmap-wrap');
  }).catch(function() {
    document.getElementById('heatmap-wrap').innerHTML = '<div style="color:var(--muted);font-size:13px">No heatmap data</div>';
  });
}

function renderHeatmap(data, containerId) {
  var el = document.getElementById(containerId);
  // Expected shape: { models: [...], tests: [...], matrix: [[...]] }
  // or { rows: [...], cols: [...], values: [[...]] }
  var models = data.models || data.rows || [];
  var tests  = data.tests  || data.cols || data.columns || [];
  var matrix = data.matrix || data.values || [];

  if (!models.length || !tests.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:13px">No heatmap data available</div>';
    return;
  }

  var html = '<table class="heatmap-table"><thead><tr><th></th>' +
    tests.slice(0, 12).map(function(t){ return '<th>' + esc(String(t).slice(0,10)) + '</th>'; }).join('') +
    '</tr></thead><tbody>' +
    models.map(function(model, i) {
      var row = matrix[i] || [];
      return '<tr><td class="hm-row-label">' + esc(String(model).slice(0,20)) + '</td>' +
        tests.slice(0, 12).map(function(_, j) {
          var v = row[j];
          var num = typeof v === 'number' ? v : null;
          var bg = num !== null ? heatColor(num) : 'rgba(255,255,255,.03)';
          var txt = num !== null ? (num > 1 ? num.toFixed(0) + '%' : (num * 100).toFixed(0) + '%') : '—';
          return '<td><div class="hm-cell" style="background:' + bg + ';color:' + (num !== null && num >= 0.7 ? '#fff' : '#888') + '">' + txt + '</div></td>';
        }).join('') + '</tr>';
    }).join('') + '</tbody></table>';
  el.innerHTML = html;
}

function heatColor(v) {
  if (v > 1) v = v / 100;
  var r, g;
  if (v >= 0.5) { r = Math.round(255 * (1 - v) * 2); g = 140; }
  else { r = 160; g = Math.round(255 * v * 2 * 0.55); }
  return 'rgba(' + r + ',' + g + ',20,0.35)';
}

/* ── Finetune History ───────────────────────────────────── */
function pollFinetuneHistory() {
  apiFetch('/api/reports/finetune-history').then(function(data) {
    var runs = Array.isArray(data) ? data : (data.runs || data.history || data.items || []);
    renderFTTable(runs);
    renderFTChart(runs);
  }).catch(function() {
    document.getElementById('ft-tbody').innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:20px">No data</td></tr>';
  });
}

function renderFTTable(runs) {
  var tbody = document.getElementById('ft-tbody');
  if (!runs.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:20px">No finetune runs</td></tr>';
    return;
  }
  tbody.innerHTML = runs.slice(0, 30).map(function(r) {
    var id     = r.finetune_id || r.run_id || r.id || '?';
    var model  = r.model_id  || r.model   || '—';
    var ds     = r.dataset   || r.dataset_id || '—';
    var rank   = r.lora_rank || r.rank     || '—';
    var epochs = r.epochs    || '—';
    var lr     = r.learning_rate || r.lr  || '—';
    var loss   = typeof r.final_loss === 'number' ? r.final_loss.toFixed(4) : '—';
    var dur    = r.duration_s ? r.duration_s.toFixed(0) + 's' : (r.duration || '—');
    var status = (r.status || 'unknown').toLowerCase();
    return '<tr>' +
      '<td style="font-family:monospace;font-size:11px;color:var(--orange-dark)">' + esc(id.slice(0,12)) + '</td>' +
      '<td style="font-weight:600">' + esc(model) + '</td>' +
      '<td style="color:var(--muted);font-size:11px">' + esc(String(ds).slice(0,20)) + '</td>' +
      '<td>' + esc(String(rank)) + '</td>' +
      '<td>' + esc(String(epochs)) + '</td>' +
      '<td style="font-family:monospace">' + esc(String(lr)) + '</td>' +
      '<td style="font-weight:600">' + loss + '</td>' +
      '<td style="color:var(--muted)">' + dur + '</td>' +
      '<td><span class="pill ' + (status === 'completed' || status === 'done' ? 'pill-pass' : status === 'failed' ? 'pill-fail' : '') + '">' + status + '</span></td>' +
      '</tr>';
  }).join('');
}

var _ftChart = null;
function renderFTChart(runs) {
  var completed = runs.filter(function(r){ return typeof r.final_loss === 'number'; });
  if (!completed.length) return;
  var labels = completed.map(function(r, i){ return r.model_id || r.model || ('run ' + (i+1)); });
  var losses  = completed.map(function(r){ return r.final_loss; });
  var ctx = document.getElementById('chart-ft').getContext('2d');
  if (_ftChart) _ftChart.destroy();
  _ftChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{ label: 'Final Loss', data: losses, borderColor: ORANGE,
                   backgroundColor: ORANGE_DIM, borderWidth: 1.5, pointRadius: 3, tension: 0.3 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a1a1a', borderColor: '#333', borderWidth: 1, titleColor: '#ccc', bodyColor: '#ccc' } },
      scales: {
        x: { ticks: { color: '#555', font: { size: 10 }, maxRotation: 30 }, grid: { color: 'rgba(255,255,255,.04)' } },
        y: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,.04)' } }
      }
    }
  });
}

/* ── Pipeline Timeline ──────────────────────────────────── */
function pollPipelineTimeline() {
  apiFetch('/api/reports/pipeline-timeline').then(function(data) {
    renderTimeline(data);
  }).catch(function() {
    document.getElementById('timeline-wrap').innerHTML = '<div style="color:var(--muted);font-size:13px">No timeline data</div>';
  });
}

function renderTimeline(data) {
  var el = document.getElementById('timeline-wrap');
  var runs = Array.isArray(data) ? data : (data.runs || data.pipelines || data.timeline || data.items || []);
  if (!runs.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:13px">No pipeline runs to display</div>';
    return;
  }
  var maxDur = Math.max.apply(null, runs.map(function(r){ return r.duration_s || r.duration || 0; })) || 1;
  var colors = ['rgba(180,90,20,.7)','rgba(80,140,220,.7)','rgba(60,180,100,.7)','rgba(220,80,80,.7)'];
  var html = runs.slice(0, 20).map(function(r, i) {
    var label = (r.model_id || r.model || r.pipeline_id || r.id || 'run').slice(0, 22);
    var dur   = r.duration_s || r.duration || 0;
    var pct   = Math.max(1, Math.round(dur / maxDur * 100));
    var score = r.final_score !== undefined ? (r.final_score > 1 ? r.final_score.toFixed(0) : (r.final_score * 100).toFixed(0)) + '%' : '';
    var color = colors[i % colors.length];
    return '<div class="timeline-row">' +
      '<div class="timeline-label">' + esc(label) + '</div>' +
      '<div class="timeline-track">' +
        '<div class="timeline-bar" style="width:' + pct + '%;background:' + color + '">' +
          (dur ? (dur > 60 ? Math.round(dur/60) + 'm' : dur + 's') : '') + (score ? ' ' + score : '') +
        '</div>' +
      '</div>' +
      '</div>';
  }).join('');
  el.innerHTML = html;
}

/* ── Datagen Stats Chart ────────────────────────────────── */
var _dgChart = null;
function pollDatagenStats() {
  apiFetch('/api/reports/datagen-stats').then(function(data) {
    renderDGChart(data);
  }).catch(function(){});
}

function renderDGChart(data) {
  var ctx = document.getElementById('chart-dg').getContext('2d');
  var labels = [], vals = [];
  if (data.by_model) {
    Object.keys(data.by_model).forEach(function(k) {
      labels.push(k); vals.push(data.by_model[k]);
    });
  } else if (Array.isArray(data)) {
    data.forEach(function(d){ labels.push(d.model || d.name || '?'); vals.push(d.count || d.tokens || d.value || 0); });
  } else if (data.models) {
    data.models.forEach(function(m){ labels.push(m.name || m.model_id || '?'); vals.push(m.count || m.tokens || 0); });
  }
  if (_dgChart) _dgChart.destroy();
  _dgChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{ label: 'Datagen Jobs', data: vals, backgroundColor: ORANGE_DIM, borderColor: ORANGE, borderWidth: 1 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a1a1a', borderColor: '#333', borderWidth: 1, titleColor: '#ccc', bodyColor: '#ccc' } },
      scales: {
        x: { ticks: { color: '#555', font: { size: 10 }, maxRotation: 30 }, grid: { color: 'rgba(255,255,255,.04)' } },
        y: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,.04)' } }
      }
    }
  });
}

/* ── Model-Suite Matrix ─────────────────────────────────── */
function pollModelSuiteMatrix() {
  apiFetch('/api/reports/model-suite-matrix').then(function(data) {
    renderHeatmap(data, 'matrix-wrap');
  }).catch(function() {
    document.getElementById('matrix-wrap').innerHTML = '<div style="color:var(--muted);font-size:13px">No matrix data</div>';
  });
}

/* ── Init ───────────────────────────────────────────────── */
function startPolling() {
  pollSummary();
  pollLeaderboard();
  pollEvalComparison();
  pollTestHeatmap();
  pollFinetuneHistory();
  pollPipelineTimeline();
  pollDatagenStats();
  pollModelSuiteMatrix();

  setInterval(pollSummary, 60000);
  setInterval(pollLeaderboard, 30000);
  setInterval(pollEvalComparison, 30000);
  setInterval(pollFinetuneHistory, 30000);
  setInterval(pollPipelineTimeline, 30000);
  setInterval(pollDatagenStats, 60000);
}

document.addEventListener('DOMContentLoaded', startPolling);
</script>
</body>
</html>
