<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BCOM-C — Pipeline</title>
<script>
  (function(){
    var t=localStorage.getItem("bcom-theme")||"dark";
    document.documentElement.setAttribute("data-theme",t);
    try { var raw=localStorage.getItem("bcom-theme-vars"); if(raw){ var vars=JSON.parse(raw); Object.keys(vars).forEach(function(k){ document.documentElement.style.setProperty(k,vars[k]); }); } } catch(_) {}
  })();
</script>
<link rel="stylesheet" href="../assets/css/bcom.css?v=3" />
<style>
  /* ── Stage Flow ──────────────────────────────────────────────────── */
  .stage-flow-wrap { overflow-x: auto; padding: 4px 0 0; }
  .stage-flow      { display: flex; align-items: center; gap: 0; min-width: max-content; padding: 20px 2px 0; }

  /* ── Stage Card ──────────────────────────────────────────────────── */
  .stage-card {
    flex-shrink: 0; width: 128px;
    border: 1px solid #1a0d05;
    background: #060402;
    position: relative;
    padding: 20px 10px 12px;
    cursor: default;
    transition: border-color .25s, background .25s, box-shadow .25s;
  }

  /* Corner bracket TL */
  .stage-card::before {
    content: '';
    position: absolute; top: 4px; left: 4px;
    width: 10px; height: 10px;
    border-top: 1.5px solid #1e1008;
    border-left: 1.5px solid #1e1008;
    transition: border-color .25s;
  }
  /* Corner bracket BR */
  .stage-card::after {
    content: '';
    position: absolute; bottom: 4px; right: 4px;
    width: 10px; height: 10px;
    border-bottom: 1.5px solid #1e1008;
    border-right: 1.5px solid #1e1008;
    transition: border-color .25s;
  }

  /* Active state */
  .stage-card.active {
    border-color: var(--orange-dark);
    background: #0b0603;
    animation: stage-pulse 2.4s ease-in-out infinite;
  }
  .stage-card.active::before,
  .stage-card.active::after { border-color: var(--orange); }

  /* Done state */
  .stage-card.done { border-color: #1a2e1a; background: #050705; }
  .stage-card.done::before,
  .stage-card.done::after  { border-color: #27ae60; }

  /* Error state */
  .stage-card.error { border-color: #3a1010; }
  .stage-card.error::before,
  .stage-card.error::after { border-color: #e74c3c; }

  @keyframes stage-pulse {
    0%,100% { box-shadow: 0 0 6px rgba(218,119,86,.10); }
    50%      { box-shadow: 0 0 22px rgba(218,119,86,.32), inset 0 0 24px rgba(218,119,86,.04); }
  }

  /* Stage number badge */
  .stage-num {
    position: absolute; top: 5px; right: 8px;
    font-size: 8px; letter-spacing: 2.5px; font-weight: 700;
    color: #1e1008; transition: color .25s;
  }
  .stage-card.active .stage-num { color: var(--orange-dark); }
  .stage-card.done   .stage-num { color: #27ae60; }
  .stage-card.error  .stage-num { color: #e74c3c; }

  /* Icon box */
  .stage-icon-box {
    width: 44px; height: 44px;
    border: 1px solid #1a0d05;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 10px;
    position: relative;
    transition: border-color .25s;
  }
  /* small dot accent on icon box TL */
  .stage-icon-box::before {
    content: '';
    position: absolute; top: -3px; left: -3px;
    width: 5px; height: 5px;
    background: #1a0d05; transition: background .25s;
  }
  .stage-card.active .stage-icon-box         { border-color: var(--orange-dark); }
  .stage-card.active .stage-icon-box::before { background: var(--orange-dark); }
  .stage-card.done   .stage-icon-box         { border-color: #1a2e1a; }
  .stage-card.done   .stage-icon-box::before { background: #27ae60; }

  /* SVG icon paths */
  .stage-icon-box svg {
    width: 22px; height: 22px; overflow: visible;
  }
  .stage-icon-box svg .ico {
    fill: none;
    stroke: #252525;
    stroke-width: 1.5;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: stroke .25s;
  }
  .stage-icon-box svg .ico-fill {
    fill: #1a1a1a; stroke: none; transition: fill .25s;
  }
  .stage-card.active .stage-icon-box svg .ico      { stroke: var(--orange); }
  .stage-card.active .stage-icon-box svg .ico-fill { fill: var(--orange-dark); }
  .stage-card.done   .stage-icon-box svg .ico      { stroke: #27ae60; }
  .stage-card.done   .stage-icon-box svg .ico-fill { fill: #27ae60; }
  .stage-card.error  .stage-icon-box svg .ico      { stroke: #e74c3c; }

  /* Stage text */
  .stage-name {
    font-size: 10px; letter-spacing: 2px; font-weight: 700;
    text-align: center; color: #2a2a2a; transition: color .25s;
  }
  .stage-card.active .stage-name { color: var(--orange); }
  .stage-card.done   .stage-name { color: #27ae60; }
  .stage-card.error  .stage-name { color: #e74c3c; }

  .stage-sub {
    font-size: 8.5px; letter-spacing: 1px; text-align: center;
    color: #1e1e1e; margin-top: 3px; transition: color .25s;
  }
  .stage-card.active .stage-sub { color: #888; }
  .stage-card.done   .stage-sub { color: #3a6a3a; }

  /* Live metric line inside card (updates when running) */
  .stage-live {
    font-size: 9px; letter-spacing: .5px; text-align: center;
    color: #161616; margin-top: 8px; min-height: 14px;
    font-family: 'Courier New', monospace;
    border-top: 1px solid #0e0805; padding-top: 6px;
    transition: color .25s, border-color .25s;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .stage-card.active .stage-live { color: var(--orange-dark); border-top-color: #1e1008; }
  .stage-card.done   .stage-live { color: #2a5a2a; border-top-color: #1a2e1a; }

  /* ── Connector ────────────────────────────────────────────────────── */
  .stage-conn {
    flex-shrink: 0;
    display: flex; align-items: center;
    padding-bottom: 52px; /* vertically centers on icon area */
    margin: 0 -1px;
  }
  .conn-line {
    width: 22px; height: 1px; background: #150c05; transition: background .25s;
  }
  .conn-arrow {
    width: 0; height: 0;
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
    border-left: 6px solid #150c05;
    flex-shrink: 0; transition: border-left-color .25s;
  }
  .stage-conn.lit .conn-line  { background: var(--orange-dark); }
  .stage-conn.lit .conn-arrow { border-left-color: var(--orange-dark); }

  /* ── Loop-back indicator ─────────────────────────────────────────── */
  .loop-back {
    display: flex; align-items: flex-start;
    min-width: max-content;
    padding: 0 64px; /* aligns roughly under centers of first/last cards */
    margin-top: 0;
  }
  .lb-stem-l, .lb-stem-r {
    width: 1px; height: 18px; background: #1a0d05; flex-shrink: 0;
    transition: background .25s;
  }
  .lb-line {
    flex: 1; height: 1px; background: #1a0d05;
    margin-top: 17px;
    display: flex; align-items: center; justify-content: center;
    position: relative; transition: background .25s;
  }
  .lb-label {
    position: absolute;
    background: #060402; padding: 0 10px;
    font-size: 8px; letter-spacing: 2.5px; color: #1a0d05;
    white-space: nowrap; transition: color .25s;
  }
  /* left arrowhead pointing left */
  .lb-arrow {
    position: absolute; left: 0;
    width: 0; height: 0;
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
    border-right: 6px solid #1a0d05;
    transform: translateX(-6px); transition: border-right-color .25s;
  }
  .loop-back.lit .lb-stem-l,
  .loop-back.lit .lb-stem-r { background: var(--orange-dark); }
  .loop-back.lit .lb-line   { background: var(--orange-dark); }
  .loop-back.lit .lb-label  { color: var(--orange-dark); }
  .loop-back.lit .lb-arrow  { border-right-color: var(--orange-dark); }

  /* ── Run table ───────────────────────────────────────────────────── */
  .run-table { width:100%; border-collapse:collapse; font-size:12px; letter-spacing:.5px; }
  .run-table th { background:#0e0a06; color:#ccc; font-weight:600; letter-spacing:1.5px;
                  padding:7px 10px; text-align:left; border-bottom:1px solid #1e1008; }
  .run-table td { padding:7px 10px; border-bottom:1px solid #120b04; vertical-align:middle; color:#ccc; }
  .run-table tr[data-run]:hover td { background:#0e0905; cursor:pointer; }
  .run-table .empty { text-align:center; color:#2a2a2a; padding:24px; letter-spacing:2px; }
  .run-status { display:inline-block; font-size:10px; letter-spacing:1.5px; padding:2px 8px; border:1px solid; }
  .run-status.running { color:#27ae60; border-color:#27ae60; }
  .run-status.queued  { color:#f39c12; border-color:#f39c12; }
  .run-status.done    { color:#444;    border-color:#333; }
  .run-status.error   { color:#e74c3c; border-color:#e74c3c; }

  /* ── Run detail panel ────────────────────────────────────────────── */
  .run-detail {
    border: 1px solid var(--orange-dark); background: #070402;
    padding: 14px 16px; margin-top: 2px; display: none;
  }
  .run-detail.open { display: block; }
  .run-detail-hdr {
    font-size: 10px; letter-spacing: 2px; color: var(--orange);
    margin-bottom: 10px; display: flex; justify-content: space-between;
  }
  .run-detail-stages {
    display: flex; gap: 8px; flex-wrap: wrap;
  }
  .rd-stage {
    border: 1px solid #1a0d05; padding: 8px 12px; font-size: 10px;
    letter-spacing: 1px; color: #555; flex: 1; min-width: 100px;
  }
  .rd-stage.done  { border-color: #1a2e1a; color: #27ae60; }
  .rd-stage.error { border-color: #3a1010; color: #e74c3c; }
  .rd-stage-name  { font-weight: 700; font-size: 9px; letter-spacing: 2px; margin-bottom: 4px; }
  .rd-stage-val   { font-size: 10px; color: inherit; }

  /* ── Active pipeline banner ──────────────────────────────────────── */
  .active-banner {
    border: 1px solid var(--orange-dark); padding: 12px 16px;
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
    background: #0c0703; margin-top: 12px;
  }
  .banner-field { font-size:11px; letter-spacing:1px; color:#ccc; }
  .banner-field span { color:var(--orange); display:block; margin-top:2px; font-weight:700; }
  .prog-track { background:#0e0905; height:6px; margin-top:6px; flex:1; min-width:120px; }
  .prog-fill  { height:6px; background:linear-gradient(to right, var(--orange-dark), #27ae60); transition:width .4s; }
  .prog-pct   { font-size:10px; letter-spacing:1px; color:var(--orange); min-width:34px; text-align:right; margin-top:4px; transition:color .4s; }

  /* Iteration badge in card header */
  .iter-badge { float: right; font-size: 9px; letter-spacing: 1.5px; color: #252525; transition: color .25s; }
  .iter-badge.lit { color: var(--orange-dark); }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-title">BCOM-C</div>
  <div class="topbar-right">
    <a class="nav-btn" href="dashboard.html"><span class="nav-arrow">&#8592;</span> DASHBOARD</a>
    <a class="nav-btn" href="data-gen.html">DATA GEN</a>
    <a class="nav-btn active" href="pipeline.html">PIPELINE</a>
    <a class="nav-btn" href="resources.html">RESOURCES</a>
    <a class="nav-btn" href="reports.html">REPORTS</a>
    <a class="nav-btn" href="orchestrator.html">ORCHESTRATOR</a>
    <a class="cog-btn" href="settings.html" title="Settings">⚙</a>
    <div class="timestamp"><span id="clock">--:--:--</span>&nbsp;&nbsp;<span id="datestamp">----/--/--</span></div>
  </div>
</div>

<div class="actionbar">
  <button class="action-btn danger" onclick="triggerAction('RESTART VLLM')">RESTART VLLM</button>
  <button class="action-btn danger" onclick="triggerAction('RESTART LLM')">RESTART LLM</button>
  <button class="action-btn" onclick="launchPipeline()">&#9654; LAUNCH PIPELINE</button>
  <button class="action-btn" id="btn-stop" style="display:none" onclick="stopPipeline()">&#9632; STOP</button>
</div>

<div class="main">
  <div class="info-grid">

    <!-- PIPELINE STAGE FLOW -->
    <div class="info-card">
      <div class="info-card-hdr">
        Closed-Loop Pipeline
        <span class="iter-badge" id="iter-badge">ITER — / —</span>
      </div>

      <div class="stage-flow-wrap">
        <div class="stage-flow" id="stage-flow">

          <!-- 01 EVALUATE -->
          <div class="stage-card" id="st-evalinitial">
            <span class="stage-num">01</span>
            <div class="stage-icon-box">
              <!-- star for eval/scoring -->
              <svg viewBox="0 0 22 22">
                <path class="ico" d="M11 2 L13.2 8 L19.5 8 L14.5 11.8 L16.5 18 L11 14.2 L5.5 18 L7.5 11.8 L2.5 8 L8.8 8 Z"/>
              </svg>
            </div>
            <div class="stage-name">EVALUATE</div>
            <div class="stage-sub">JUDGE + SUITE</div>
            <div class="stage-live" id="live-evalinitial">—</div>
          </div>

          <div class="stage-conn" id="arr-0">
            <div class="conn-line"></div><div class="conn-arrow"></div>
          </div>

          <!-- 02 ANALYZE -->
          <div class="stage-card" id="st-analyze">
            <span class="stage-num">02</span>
            <div class="stage-icon-box">
              <!-- bar chart / analysis icon -->
              <svg viewBox="0 0 22 22">
                <rect class="ico" x="3"  y="13" width="3" height="6" rx=".5"/>
                <rect class="ico" x="8"  y="9"  width="3" height="10" rx=".5"/>
                <rect class="ico" x="13" y="6"  width="3" height="13" rx=".5"/>
                <rect class="ico" x="18" y="11" width="3" height="8"  rx=".5"/>
                <path class="ico" d="M2 19 L20 19"/>
                <path class="ico" d="M4.5 12 L9.5 8 L14.5 5 L19.5 10" stroke-dasharray="1.5 1"/>
              </svg>
            </div>
            <div class="stage-name">ANALYZE</div>
            <div class="stage-sub">ADVISOR AI</div>
            <div class="stage-live" id="live-analyze">—</div>
          </div>

          <div class="stage-conn" id="arr-1">
            <div class="conn-line"></div><div class="conn-arrow"></div>
          </div>

          <!-- 03 GENERATE -->
          <div class="stage-card" id="st-generate">
            <span class="stage-num">03</span>
            <div class="stage-icon-box">
              <!-- database rows / data table icon -->
              <svg viewBox="0 0 22 22">
                <rect class="ico" x="2" y="3"   width="18" height="4"  rx=".5"/>
                <rect class="ico" x="2" y="9"   width="18" height="4"  rx=".5"/>
                <rect class="ico" x="2" y="15"  width="11" height="4"  rx=".5"/>
                <path class="ico" d="M15 15 L20 17 L15 19"/>
              </svg>
            </div>
            <div class="stage-name">GENERATE</div>
            <div class="stage-sub">Q&amp;A PAIRS</div>
            <div class="stage-live" id="live-generate">—</div>
          </div>

          <div class="stage-conn" id="arr-2">
            <div class="conn-line"></div><div class="conn-arrow"></div>
          </div>

          <!-- 04 FINE-TUNE -->
          <div class="stage-card" id="st-train">
            <span class="stage-num">04</span>
            <div class="stage-icon-box">
              <!-- neural net: 2 input, 1 hidden, 2 output -->
              <svg viewBox="0 0 22 22">
                <circle class="ico" cx="3"  cy="6"  r="2"/>
                <circle class="ico" cx="3"  cy="16" r="2"/>
                <circle class="ico" cx="11" cy="11" r="2.5"/>
                <circle class="ico" cx="19" cy="7"  r="2"/>
                <circle class="ico" cx="19" cy="15" r="2"/>
                <line class="ico" x1="5"  y1="6.8"  x2="8.5"  y2="10"/>
                <line class="ico" x1="5"  y1="15.2" x2="8.5"  y2="12"/>
                <line class="ico" x1="13.5" y1="10"   x2="17" y2="7.8"/>
                <line class="ico" x1="13.5" y1="12"   x2="17" y2="14.2"/>
                <line class="ico" x1="3" y1="8" x2="3" y2="14"/>
              </svg>
            </div>
            <div class="stage-name">FINE-TUNE</div>
            <div class="stage-sub">LoRA</div>
            <div class="stage-live" id="live-train">—</div>
          </div>

          <div class="stage-conn" id="arr-3">
            <div class="conn-line"></div><div class="conn-arrow"></div>
          </div>

          <!-- 05 RE-EVAL -->
          <div class="stage-card" id="st-reeval">
            <span class="stage-num">05</span>
            <div class="stage-icon-box">
              <!-- refresh + star: re-evaluation -->
              <svg viewBox="0 0 22 22">
                <path class="ico" d="M4 11 A7 7 0 1 1 7 17"/>
                <path class="ico" d="M4 17 L4 11 L10 11"/>
                <path class="ico" d="M11 5 L12.2 8.4 L15.8 8.4 L13 10.5 L14 14 L11 11.8 L8 14 L9 10.5 L6.2 8.4 L9.8 8.4 Z" transform="translate(0 1) scale(0.7) translate(4.7 3)"/>
              </svg>
            </div>
            <div class="stage-name">RE-EVAL</div>
            <div class="stage-sub">PASS / LOOP</div>
            <div class="stage-live" id="live-reeval">—</div>
          </div>

        </div><!-- end .stage-flow -->

        <!-- Loop-back arc below the flow -->
        <div class="loop-back" id="loop-row">
          <div class="lb-stem-l"></div>
          <div class="lb-line">
            <div class="lb-arrow"></div>
            <span class="lb-label">&#x21BA;&nbsp; LOOP &mdash; SCORE BELOW TARGET</span>
          </div>
          <div class="lb-stem-r"></div>
        </div>

      </div><!-- end .stage-flow-wrap -->

      <!-- Active pipeline banner -->
      <div class="active-banner" id="active-banner" style="display:none">
        <div class="banner-field">RUN ID<span id="bp-id">--</span></div>
        <div class="banner-field">MODEL<span id="bp-model">--</span></div>
        <div class="banner-field">BACKEND<span id="bp-backend">--</span></div>
        <div class="banner-field">NODE<span id="bp-node">--</span></div>
        <div class="banner-field">ITERATION<span id="bp-iter">--</span></div>
        <div class="banner-field">SCORE<span id="bp-score">--</span></div>
        <div class="banner-field" style="flex:1">
          PROGRESS
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="prog-track" style="flex:1"><div class="prog-fill" id="bp-prog" style="width:0%"></div></div>
            <span class="prog-pct" id="bp-prog-pct">0%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- LAUNCH CONFIG -->
    <div class="info-card">
      <div class="info-card-hdr">Pipeline Configuration</div>
      <div class="form-body">
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Base Model</label>
            <input class="form-input" id="pl-model" type="text" placeholder="e.g. llama3.2:3b" />
          </div>
          <div class="form-group">
            <label class="form-label">Backend</label>
            <select class="form-select" id="pl-backend">
              <option value="ollama">Ollama</option>
              <option value="vllm">vLLM</option>
              <option value="bedrock">Bedrock</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Eval Suite</label>
            <input class="form-input" id="pl-suite" type="text" value="hard_15" />
          </div>
        </div>
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Target Score %</label>
            <input class="form-input" id="pl-target" type="number" value="80" min="1" max="100" />
          </div>
          <div class="form-group">
            <label class="form-label">Max Iterations</label>
            <input class="form-input" id="pl-maxiter" type="number" value="3" min="1" />
          </div>
          <div class="form-group" style="display:flex;align-items:flex-end;padding-bottom:4px;">
            <label style="display:flex;align-items:center;gap:8px;font-size:11px;letter-spacing:1px;color:#ccc;cursor:pointer;">
              <input type="checkbox" id="pl-auto" style="accent-color:var(--orange-dark);" /> AUTO-LOOP UNTIL TARGET
            </label>
          </div>
        </div>
        <button class="form-submit" style="margin-top:12px;" onclick="launchPipeline()">&#9654; Launch Pipeline</button>
        <div class="form-output" id="pl-output">--</div>
      </div>
    </div>

    <!-- PIPELINE RUN HISTORY -->
    <div class="info-card">
      <div class="info-card-hdr" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Run History <span style="font-size:9px;color:#555;letter-spacing:1px;">— click row to inspect</span></span>
        <button class="action-btn" style="font-size:10px;padding:2px 10px;" onclick="exportRuns()">&#8659; Export</button>
      </div>
      <div style="overflow-x:auto">
        <table class="run-table">
          <thead>
            <tr><th>RUN ID</th><th>MODEL</th><th>BACKEND</th><th>NODE</th><th>SUITE</th><th>ITERS</th><th>FINAL SCORE</th><th>TARGET</th><th>STATUS</th><th>DURATION</th></tr>
          </thead>
          <tbody id="run-history-body">
            <tr><td colspan="10" class="empty">NO PIPELINE RUNS YET</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Run detail drill-down (hidden by default) -->
      <div class="run-detail" id="run-detail">
        <div class="run-detail-hdr">
          <span>RUN DETAIL — <span id="rd-id">--</span></span>
          <span style="cursor:pointer;color:#555;" onclick="closeDetail()">&#10005; CLOSE</span>
        </div>
        <div class="run-detail-stages" id="rd-stages"></div>
      </div>
    </div>

  </div>

  <div class="log-panel" id="log">
    <div class="log-line"><span class="log-time">--:--:--</span><span class="log-msg info">PIPELINE module ready. Configure and launch a run.</span></div>
  </div>
</div>

<div class="footer">
  <span>BOB-AI // BCOM-C v0.1</span>
  <span id="footer-date"></span>
  <span>SESSION ACTIVE</span>
</div>

<script src="../assets/js/bcom.js?v=5"></script>
<script>
  BCOM.apiBase      = '';
  BCOM.pollInterval = 5000;
  startPolling();

  const STAGE_IDS  = ['st-evalinitial','st-analyze','st-generate','st-train','st-reeval'];
  const LIVE_IDS   = ['live-evalinitial','live-analyze','live-generate','live-train','live-reeval'];
  const ARROW_IDS  = ['arr-0','arr-1','arr-2','arr-3'];
  const STEP_MAP   = {
    idle:-1, evaluating:0, eval_started:0,
    analyzing:1, analysis_complete:1,
    generating:2, generation_started:2,
    fine_tuning:3, finetune_started:3,
    re_evaluating:4, reeval_started:4, complete:5
  };

  let _pipelines = [], _activePipeline = null;

  function setProgress(pct) {
    const p = Math.round(Math.min(Math.max(pct, 0), 100));
    document.getElementById('bp-prog').style.width = p + '%';
    const lbl = document.getElementById('bp-prog-pct');
    lbl.textContent = p + '%';
    lbl.style.color = p >= 66 ? '#27ae60' : p >= 33 ? '#e8a040' : 'var(--orange)';
  }

  function setStageVisual(stepIdx, isComplete, isFailed) {
    STAGE_IDS.forEach(function(id, i) {
      const el = document.getElementById(id);
      if (!el) return;
      if (isComplete)                     el.className = 'stage-card done';
      else if (i < stepIdx)               el.className = 'stage-card done';
      else if (isFailed && i === stepIdx) el.className = 'stage-card error';
      else if (i === stepIdx)             el.className = 'stage-card active';
      else                                el.className = 'stage-card';
    });
    ARROW_IDS.forEach(function(id, i) {
      const el = document.getElementById(id);
      if (el) el.className = 'stage-conn' + (i < stepIdx ? ' lit' : '');
    });
  }

  function clearStages() {
    STAGE_IDS.forEach(function(id) {
      const el = document.getElementById(id);
      if (el) el.className = 'stage-card';
    });
    ARROW_IDS.forEach(function(id) {
      const el = document.getElementById(id);
      if (el) el.className = 'stage-conn';
    });
    LIVE_IDS.forEach(function(id) {
      const el = document.getElementById(id);
      if (el) el.textContent = '—';
    });
  }

  function updateLiveMetrics(p, stepIdx, lastIter) {
    const ar = lastIter && lastIter.advisor_result;
    const live = [
      lastIter && lastIter.pass_rate != null ? lastIter.pass_rate.toFixed(1) + '%' : 'suite: ' + (p.eval_suite || '--'),
      ar ? String((ar.datagen_services || '').split(',').length) + ' services' : (stepIdx === 1 ? 'analyzing...' : '--'),
      lastIter && lastIter.datagen_job_id ? lastIter.datagen_job_id.slice(-8) : (stepIdx === 2 ? 'generating...' : '--'),
      lastIter && lastIter.finetune_job_id ? lastIter.finetune_job_id.slice(-8) : (stepIdx === 3 ? 'training...' : '--'),
      lastIter && lastIter.reeval_pass_rate != null ? lastIter.reeval_pass_rate.toFixed(1) + '%' : (stepIdx === 4 ? 'evaluating...' : '--')
    ];
    LIVE_IDS.forEach(function(id, i) {
      const el = document.getElementById(id);
      if (el) el.textContent = live[i] || '—';
    });
  }

  // ── Poll pipeline API ─────────────────────────────────────────────
  async function pollPipelines() {
    try {
      const res = await fetch((BCOM.apiBase || '') + '/api/pipeline/', { cache: 'no-store' });
      if (!res.ok) return;
      const data = await res.json();
      _pipelines = Array.isArray(data) ? data : (data.pipelines || []);

      const active = _pipelines.find(function(p) { return p.status === 'running'; });

      if (active) {
        _activePipeline = active;
        const stepIdx  = STEP_MAP[active.current_step] != null ? STEP_MAP[active.current_step] : -1;
        const isDone   = active.status === 'target_reached' || active.status === 'max_iterations_reached';
        const isFailed = active.status === 'failed';
        const lastIter = active.iterations && active.iterations.length
          ? active.iterations[active.iterations.length - 1] : null;
        const score = lastIter
          ? (lastIter.reeval_pass_rate != null ? lastIter.reeval_pass_rate : lastIter.pass_rate) : null;

        setStageVisual(Math.max(0, stepIdx), isDone, isFailed);
        updateLiveMetrics(active, stepIdx, lastIter);

        document.getElementById('active-banner').style.display = 'flex';
        setText('bp-id',      active.pipeline_id ? active.pipeline_id.slice(-12) : '--');
        setText('bp-model',   active.model_name  || '--');
        setText('bp-backend', (active.model_backend || '--').toUpperCase());
        setText('bp-node',    'DGX-SPARK');
        setText('bp-iter',    active.current_iteration + ' / ' + active.max_iterations);
        setText('bp-score',   score != null ? score.toFixed(1) + '%' : '--');
        setProgress(score != null ? Math.min((score / active.target_pass_rate) * 100, 100) : 0);

        const lb = document.getElementById('loop-row');
        if (lb) lb.className = 'loop-back' + (active.current_iteration > 1 && stepIdx <= 0 ? ' lit' : '');

        const badge = document.getElementById('iter-badge');
        if (badge) {
          badge.textContent = 'ITER ' + active.current_iteration + ' / ' + active.max_iterations;
          badge.className = 'iter-badge lit';
        }
        document.getElementById('btn-stop').style.display = '';
      } else {
        if (_activePipeline) {
          _activePipeline = null;
          clearStages();
          document.getElementById('active-banner').style.display = 'none';
          const badge = document.getElementById('iter-badge');
          if (badge) { badge.textContent = 'ITER — / —'; badge.className = 'iter-badge'; }
          const lb = document.getElementById('loop-row');
          if (lb) lb.className = 'loop-back';
        }
        document.getElementById('btn-stop').style.display = 'none';
      }
      renderRuns(_pipelines);
    } catch(e) { /* soft fail */ }
  }

  // ── Launch pipeline ───────────────────────────────────────────────
  async function launchPipeline() {
    const model   = document.getElementById('pl-model').value.trim();
    const backend = document.getElementById('pl-backend').value;
    const suite   = document.getElementById('pl-suite').value.trim() || 'hard_15';
    const target  = parseFloat(document.getElementById('pl-target').value)  || 80;
    const maxiter = parseInt(document.getElementById('pl-maxiter').value)   || 3;
    const autoAdv = document.getElementById('pl-auto').checked;
    if (!model) { logLine('Form error: Base Model required', 'warn'); return; }

    logLine('CMD: LAUNCH PIPELINE — ' + model + ' / ' + backend + ' / ' + suite, 'info');
    const out = document.getElementById('pl-output');
    out.textContent = 'Launching...'; out.style.color = '#888';

    try {
      const res = await fetch((BCOM.apiBase || '') + '/api/pipeline/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model_name: model, model_backend: backend, eval_suite: suite,
          target_pass_rate: target, max_iterations: maxiter, auto_advance: autoAdv
        })
      });
      if (!res.ok) {
        const err = await res.json().catch(function() { return {}; });
        const msg = err.detail || res.statusText;
        logLine('Launch failed: ' + msg, 'warn');
        out.textContent = 'Error: ' + msg; out.style.color = '#e74c3c';
        return;
      }
      const data = await res.json();
      const pid = data.pipeline_id || '—';
      logLine('Pipeline started: ' + pid, 'info');
      out.textContent = 'Launched: ' + pid; out.style.color = 'var(--orange-dark)';
      pollPipelines();
    } catch(e) {
      logLine('Launch error: ' + e.message, 'warn');
      out.textContent = 'Error: ' + e.message; out.style.color = '#e74c3c';
    }
  }

  // ── Stop / cancel pipeline ────────────────────────────────────────
  async function stopPipeline() {
    if (!_activePipeline) return;
    const id = _activePipeline.pipeline_id;
    logLine('CMD: CANCEL PIPELINE — ' + id, 'warn');
    try {
      await fetch((BCOM.apiBase || '') + '/api/pipeline/' + id + '/cancel', { method: 'POST' });
      pollPipelines();
    } catch(e) { logLine('Cancel error: ' + e.message, 'warn'); }
  }

  // ── Manual step advance ───────────────────────────────────────────
  async function advancePipeline(pipeId, step) {
    try {
      await fetch((BCOM.apiBase || '') + '/api/pipeline/' + pipeId + '/advance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ step: step })
      });
      pollPipelines();
    } catch(e) { logLine('Advance error: ' + e.message, 'warn'); }
  }

  // ── Render run history table (DOM-only, no HTML strings) ──────────
  function renderRuns(pipes) {
    const tb = document.getElementById('run-history-body');
    while (tb.firstChild) tb.removeChild(tb.firstChild);
    if (!pipes || !pipes.length) {
      const row = tb.insertRow(); const cell = row.insertCell();
      cell.colSpan = 10; cell.className = 'empty';
      cell.textContent = 'NO PIPELINE RUNS YET'; return;
    }

    function dur(p) {
      if (!p.started_at) return '--';
      const ms = (p.completed_at ? new Date(p.completed_at) : new Date()) - new Date(p.started_at);
      const h = Math.floor(ms / 3600000), m = Math.floor((ms % 3600000) / 60000);
      return h > 0 ? h + 'h ' + m + 'm' : m + 'm';
    }
    function stCls(s) {
      return s === 'target_reached' ? 'done' : s === 'failed' ? 'error' : s === 'running' ? 'running' : 'done';
    }
    function stLbl(s) {
      return ({target_reached:'PASSED',max_iterations_reached:'MAX ITERS',failed:'FAILED',running:'RUNNING'})[s] || s.toUpperCase();
    }

    pipes.forEach(function(p) {
      const lastIter = p.iterations && p.iterations.length ? p.iterations[p.iterations.length - 1] : null;
      const score = lastIter ? (lastIter.reeval_pass_rate != null ? lastIter.reeval_pass_rate : lastIter.pass_rate) : null;
      const row = tb.insertRow();
      row.style.cursor = 'pointer';
      row.addEventListener('click', (function(pid){ return function(){ openDetail(pid); }; })(p.pipeline_id));

      const vals = [
        p.pipeline_id.slice(-14), p.model_name || '--',
        (p.model_backend || '--').toUpperCase(), 'DGX-SPARK',
        p.eval_suite || '--',
        p.current_iteration + ' / ' + p.max_iterations,
        score != null ? score.toFixed(1) + '%' : '--',
        p.target_pass_rate + '%', null, dur(p)
      ];
      vals.forEach(function(val, i) {
        const td = row.insertCell();
        if (i === 0) { td.style.color = 'var(--orange-dark)'; td.style.fontSize = '10px'; }
        if (val === null) {
          const span = document.createElement('span');
          span.className = 'run-status ' + stCls(p.status);
          span.textContent = stLbl(p.status); td.appendChild(span);
        } else { td.textContent = val; }
      });
    });
  }

  // ── Detail drill-down (DOM-only) ──────────────────────────────────
  function openDetail(pipeId) {
    const p = _pipelines.find(function(x) { return x.pipeline_id === pipeId; });
    if (!p) return;
    document.getElementById('rd-id').textContent = pipeId;
    const lastIter = p.iterations && p.iterations.length ? p.iterations[p.iterations.length - 1] : null;
    const ar    = lastIter && lastIter.advisor_result;
    const score = lastIter ? (lastIter.reeval_pass_rate != null ? lastIter.reeval_pass_rate : lastIter.pass_rate) : null;
    const stages = [
      { name:'EVALUATE',  val:'Suite: ' + p.eval_suite + (lastIter && lastIter.pass_rate != null ? ' → ' + lastIter.pass_rate.toFixed(1) + '%' : ''), status: lastIter ? 'done' : '' },
      { name:'ANALYZE',   val: ar ? (ar.datagen_services || '').slice(0, 60) : '--', status: ar ? 'done' : '' },
      { name:'GENERATE',  val: lastIter && lastIter.datagen_job_id ? lastIter.datagen_job_id : '--', status: lastIter && lastIter.datagen_job_id ? 'done' : '' },
      { name:'FINE-TUNE', val: lastIter && lastIter.finetune_job_id ? lastIter.finetune_job_id : '--', status: lastIter && lastIter.finetune_job_id ? 'done' : '' },
      { name:'RE-EVAL',   val: score != null ? score.toFixed(1) + '% ' + (score >= p.target_pass_rate ? '— PASS' : '— below target') : '--', status: lastIter && lastIter.reeval_run_id ? (score >= p.target_pass_rate ? 'done' : 'error') : '' }
    ];
    const container = document.getElementById('rd-stages');
    while (container.firstChild) container.removeChild(container.firstChild);
    stages.forEach(function(s) {
      const div = document.createElement('div');
      div.className = 'rd-stage ' + s.status;
      const nd = document.createElement('div'); nd.className = 'rd-stage-name'; nd.textContent = s.name;
      const vd = document.createElement('div'); vd.className = 'rd-stage-val';  vd.textContent = s.val;
      div.appendChild(nd); div.appendChild(vd);
      container.appendChild(div);
    });
    document.getElementById('run-detail').classList.add('open');
  }
  function closeDetail() { document.getElementById('run-detail').classList.remove('open'); }

  function exportRuns() { logLine('CMD: EXPORT RUN HISTORY', 'info'); }

  // ── Initial load + polling ────────────────────────────────────────
  pollPipelines();
  setInterval(pollPipelines, 5000);

</script>
</body>
</html>
