<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pipeline — BCOM-C</title>
<script>
  (function(){
    var t=localStorage.getItem('bcom-theme')||'dark';
    document.documentElement.setAttribute('data-theme',t);
    try{var r=localStorage.getItem('bcom-theme-vars');if(r){var v=JSON.parse(r);Object.keys(v).forEach(function(k){document.documentElement.style.setProperty(k,v[k]);});}}catch(_){}
  })();
</script>
<link rel="stylesheet" href="../bcom.css?v=3">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
/* ── Stage Flow ─────────────────────────────────────────── */
.stage-flow-wrap{overflow-x:auto;padding:4px 0 0}
.stage-flow{display:flex;align-items:center;gap:0;min-width:max-content;padding:20px 2px 0}

.stage-card{flex-shrink:0;width:128px;border:1px solid #1a0d05;background:#060402;position:relative;padding:20px 10px 12px;cursor:default;transition:border-color .25s,background .25s,box-shadow .25s}
.stage-card::before{content:'';position:absolute;top:4px;left:4px;width:10px;height:10px;border-top:1.5px solid #1e1008;border-left:1.5px solid #1e1008;transition:border-color .25s}
.stage-card::after{content:'';position:absolute;bottom:4px;right:4px;width:10px;height:10px;border-bottom:1.5px solid #1e1008;border-right:1.5px solid #1e1008;transition:border-color .25s}
.stage-card.active{border-color:var(--orange-dark);background:#0b0603;animation:stage-pulse 2.4s ease-in-out infinite}
.stage-card.active::before,.stage-card.active::after{border-color:var(--orange)}
.stage-card.done{border-color:#1a2e1a;background:#050705}
.stage-card.done::before,.stage-card.done::after{border-color:#27ae60}
.stage-card.error{border-color:#3a1010}
.stage-card.error::before,.stage-card.error::after{border-color:#e74c3c}
@keyframes stage-pulse{0%,100%{box-shadow:0 0 6px rgba(218,119,86,.10)}50%{box-shadow:0 0 22px rgba(218,119,86,.32),inset 0 0 24px rgba(218,119,86,.04)}}

.stage-num{position:absolute;top:5px;right:8px;font-size:8px;letter-spacing:2.5px;font-weight:700;color:#1e1008;transition:color .25s}
.stage-card.active .stage-num{color:var(--orange-dark)}
.stage-card.done   .stage-num{color:#27ae60}
.stage-card.error  .stage-num{color:#e74c3c}

.stage-icon-box{width:44px;height:44px;border:1px solid #1a0d05;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;position:relative;transition:border-color .25s}
.stage-icon-box::before{content:'';position:absolute;top:-3px;left:-3px;width:5px;height:5px;background:#1a0d05;transition:background .25s}
.stage-card.active .stage-icon-box{border-color:var(--orange-dark)}
.stage-card.active .stage-icon-box::before{background:var(--orange-dark)}
.stage-card.done   .stage-icon-box{border-color:#1a2e1a}
.stage-card.done   .stage-icon-box::before{background:#27ae60}
.stage-icon-box svg{width:22px;height:22px;overflow:visible}
.stage-icon-box svg .ico{fill:none;stroke:#252525;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;transition:stroke .25s}
.stage-icon-box svg .ico-fill{fill:#1a1a1a;stroke:none;transition:fill .25s}
.stage-card.active .stage-icon-box svg .ico{stroke:var(--orange)}
.stage-card.active .stage-icon-box svg .ico-fill{fill:var(--orange-dark)}
.stage-card.done   .stage-icon-box svg .ico{stroke:#27ae60}
.stage-card.done   .stage-icon-box svg .ico-fill{fill:#27ae60}
.stage-card.error  .stage-icon-box svg .ico{stroke:#e74c3c}

.stage-name{font-size:10px;letter-spacing:2px;font-weight:700;text-align:center;color:#2a2a2a;transition:color .25s}
.stage-card.active .stage-name{color:var(--orange)}
.stage-card.done   .stage-name{color:#27ae60}
.stage-card.error  .stage-name{color:#e74c3c}
.stage-sub{font-size:8.5px;letter-spacing:1px;text-align:center;color:#1e1e1e;margin-top:3px;transition:color .25s}
.stage-card.active .stage-sub{color:#888}
.stage-card.done   .stage-sub{color:#3a6a3a}
.stage-live{font-size:9px;letter-spacing:.5px;text-align:center;color:#161616;margin-top:8px;min-height:14px;font-family:'Courier New',monospace;border-top:1px solid #0e0805;padding-top:6px;transition:color .25s,border-color .25s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stage-card.active .stage-live{color:var(--orange-dark);border-top-color:#1e1008}
.stage-card.done   .stage-live{color:#2a5a2a;border-top-color:#1a2e1a}

.stage-conn{flex-shrink:0;display:flex;align-items:center;padding-bottom:52px;margin:0 -1px}
.conn-line{width:22px;height:1px;background:#150c05;transition:background .25s}
.conn-arrow{width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;border-left:6px solid #150c05;flex-shrink:0;transition:border-left-color .25s}
.stage-conn.lit .conn-line{background:var(--orange-dark)}
.stage-conn.lit .conn-arrow{border-left-color:var(--orange-dark)}

.loop-back{display:flex;align-items:flex-start;min-width:max-content;padding:0 64px;margin-top:0}
.lb-stem-l,.lb-stem-r{width:1px;height:18px;background:#1a0d05;flex-shrink:0;transition:background .25s}
.lb-line{flex:1;height:1px;background:#1a0d05;margin-top:17px;display:flex;align-items:center;justify-content:center;position:relative;transition:background .25s}
.lb-label{position:absolute;background:#060402;padding:0 10px;font-size:8px;letter-spacing:2.5px;color:#1a0d05;white-space:nowrap;transition:color .25s}
.lb-arrow{position:absolute;left:0;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;border-right:6px solid #1a0d05;transform:translateX(-6px);transition:border-right-color .25s}
.loop-back.lit .lb-stem-l,.loop-back.lit .lb-stem-r{background:var(--orange-dark)}
.loop-back.lit .lb-line{background:var(--orange-dark)}
.loop-back.lit .lb-label{color:var(--orange-dark)}
.loop-back.lit .lb-arrow{border-right-color:var(--orange-dark)}

.iter-badge{float:right;font-size:9px;letter-spacing:1.5px;color:#252525;transition:color .25s}
.iter-badge.lit{color:var(--orange-dark)}

/* ── Active banner ──────────────────────────────────────── */
.active-banner{border:1px solid var(--orange-dark);padding:12px 16px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;background:#0c0703;margin-top:12px}
.banner-field{font-size:11px;letter-spacing:1px;color:#ccc}
.banner-field span{color:var(--orange);display:block;margin-top:2px;font-weight:700}
.prog-track{background:#0e0905;height:6px;margin-top:6px;flex:1;min-width:120px}
.prog-fill{height:6px;background:var(--orange-dark);transition:width .4s}

/* ── Pipeline cards ─────────────────────────────────────── */
.pl-section{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:20px}
.pl-section-title{font-size:13px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}

/* ── Config form ─────────────────────────────────────────── */
.cfg-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.cfg-grid.g2{grid-template-columns:repeat(2,1fr)}
@media(max-width:600px){.cfg-grid,.cfg-grid.g2{grid-template-columns:1fr}}
.cfg-group label{display:block;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px}
.cfg-group input,.cfg-group select{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--fg);border-radius:6px;padding:8px 10px;font-size:13px;box-sizing:border-box}
.cfg-group select option{background:var(--card)}

/* ── Run history ─────────────────────────────────────────── */
.pl-table{width:100%;border-collapse:collapse;font-size:12px;letter-spacing:.5px}
.pl-table th{text-align:left;font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:8px 10px;border-bottom:1px solid var(--border)}
.pl-table td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.04);color:var(--fg);vertical-align:middle}
.pl-table tr:hover td{background:rgba(255,255,255,.025);cursor:pointer}
.run-status{display:inline-block;font-size:10px;letter-spacing:1.5px;padding:2px 8px;border:1px solid}
.run-status.running{color:#27ae60;border-color:#27ae60}
.run-status.queued{color:#f39c12;border-color:#f39c12}
.run-status.done,.run-status.completed{color:#444;border-color:#333}
.run-status.error,.run-status.failed{color:#e74c3c;border-color:#e74c3c}
.run-status.cancelled{color:#888;border-color:#555}

/* ── Loss chart ─────────────────────────────────────────── */
.loss-chart-wrap{position:relative;height:220px}

/* ── Events log ─────────────────────────────────────────── */
.ev-log{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px 14px;max-height:180px;overflow-y:auto;font-family:'Courier New',monospace;font-size:11px}
.ev-log-line{padding:2px 0;border-bottom:1px solid rgba(255,255,255,.03);color:var(--muted)}
.ev-log-line.info{color:var(--fg)}
.ev-log-line.warn{color:#f39c12}
.ev-log-line.err{color:#e74c3c}
.ev-log-line .ev-time{color:#333;margin-right:8px}
</style>
</head>
<body>
<nav class="bcom-nav">
  <a href="../index.html" class="bcom-nav-brand">BCOM-C</a>
  <div class="bcom-nav-links">
    <a href="pipeline.html" class="active">PIPELINE</a>
    <a href="data-gen.html">DATAGEN</a>
    <a href="analytics.html">ANALYTICS</a>
    <a href="coordinator.html">COORDINATOR</a>
    <a href="datasets.html">DATASETS</a>
    <a href="evals.html">EVALS</a>
    <a href="models.html">MODELS</a>
    <a href="monitor.html">MONITOR</a>
    <a href="deploy.html">DEPLOY</a>
    <a href="reports.html">REPORTS</a>
    <a href="resources.html">⚙</a>
  </div>
</nav>

<div class="bcom-page">
  <div class="bcom-page-header">
    <h1 class="bcom-page-title">Pipeline</h1>
    <div class="bcom-page-actions">
      <button class="bcom-btn bcom-btn-sm bcom-btn-danger" id="btn-cancel" style="display:none" onclick="cancelActivePipeline()">■ CANCEL</button>
      <span id="pl-last-refresh" style="font-size:11px;color:var(--muted)">—</span>
    </div>
  </div>

  <!-- Stage Flow -->
  <div class="pl-section">
    <div class="pl-section-title">
      Closed-Loop Pipeline
      <span class="iter-badge" id="iter-badge">ITER — / —</span>
    </div>
    <div class="stage-flow-wrap">
      <div class="stage-flow" id="stage-flow">
        <div class="stage-card" id="st-data">
          <span class="stage-num">01</span>
          <div class="stage-icon-box">
            <svg viewBox="0 0 22 22"><rect class="ico" x="2" y="3" width="18" height="4" rx=".5"/><rect class="ico" x="2" y="9" width="18" height="4" rx=".5"/><rect class="ico" x="2" y="15" width="11" height="4" rx=".5"/><path class="ico" d="M15 15 L20 17 L15 19"/></svg>
          </div>
          <div class="stage-name">DATA GEN</div>
          <div class="stage-sub">Q&amp;A PAIRS</div>
          <div class="stage-live" id="live-data">—</div>
        </div>
        <div class="stage-conn" id="arr-0"><div class="conn-line"></div><div class="conn-arrow"></div></div>
        <div class="stage-card" id="st-train">
          <span class="stage-num">02</span>
          <div class="stage-icon-box">
            <svg viewBox="0 0 22 22"><circle class="ico" cx="3" cy="6" r="2"/><circle class="ico" cx="3" cy="16" r="2"/><circle class="ico" cx="11" cy="11" r="2.5"/><circle class="ico" cx="19" cy="7" r="2"/><circle class="ico" cx="19" cy="15" r="2"/><line class="ico" x1="5" y1="6.8" x2="8.5" y2="10"/><line class="ico" x1="5" y1="15.2" x2="8.5" y2="12"/><line class="ico" x1="13.5" y1="10" x2="17" y2="7.8"/><line class="ico" x1="13.5" y1="12" x2="17" y2="14.2"/><line class="ico" x1="3" y1="8" x2="3" y2="14"/></svg>
          </div>
          <div class="stage-name">FINE-TUNE</div>
          <div class="stage-sub">LoRA</div>
          <div class="stage-live" id="live-train">—</div>
        </div>
        <div class="stage-conn" id="arr-1"><div class="conn-line"></div><div class="conn-arrow"></div></div>
        <div class="stage-card" id="st-deploy">
          <span class="stage-num">03</span>
          <div class="stage-icon-box">
            <svg viewBox="0 0 22 22"><rect class="ico" x="3" y="13" width="16" height="6" rx="1"/><circle class="ico-fill" cx="6.5" cy="16" r="1"/><circle class="ico-fill" cx="9.5" cy="16" r="1"/><rect class="ico" x="3" y="8.5" width="16" height="4" rx=".5"/><circle class="ico-fill" cx="6.5" cy="10.5" r=".8"/><line class="ico" x1="11" y1="7" x2="11" y2="1"/><path class="ico" d="M8 4 L11 1 L14 4"/></svg>
          </div>
          <div class="stage-name">DEPLOY</div>
          <div class="stage-sub">vLLM / OLLAMA</div>
          <div class="stage-live" id="live-deploy">—</div>
        </div>
        <div class="stage-conn" id="arr-2"><div class="conn-line"></div><div class="conn-arrow"></div></div>
        <div class="stage-card" id="st-eval">
          <span class="stage-num">04</span>
          <div class="stage-icon-box">
            <svg viewBox="0 0 22 22"><path class="ico" d="M11 2 L13.2 8 L19.5 8 L14.5 11.8 L16.5 18 L11 14.2 L5.5 18 L7.5 11.8 L2.5 8 L8.8 8 Z"/></svg>
          </div>
          <div class="stage-name">EVAL</div>
          <div class="stage-sub">JUDGE + SUITE</div>
          <div class="stage-live" id="live-eval">—</div>
        </div>
        <div class="stage-conn" id="arr-3"><div class="conn-line"></div><div class="conn-arrow"></div></div>
        <div class="stage-card" id="st-check">
          <span class="stage-num">05</span>
          <div class="stage-icon-box">
            <svg viewBox="0 0 22 22"><circle class="ico" cx="11" cy="11" r="8"/><path class="ico" d="M7.5 11 L10 13.5 L15 8"/><path class="ico" d="M15 14.5 Q17.5 17 15.5 19 Q13 21 11 19.5" stroke-dasharray="1.5 1.5"/><path class="ico" d="M11 19.5 L9.5 21.5 M11 19.5 L12.5 21.5"/></svg>
          </div>
          <div class="stage-name">CHECK</div>
          <div class="stage-sub">PASS / LOOP</div>
          <div class="stage-live" id="live-check">—</div>
        </div>
      </div>
      <div class="loop-back" id="loop-row">
        <div class="lb-stem-l"></div>
        <div class="lb-line">
          <div class="lb-arrow"></div>
          <span class="lb-label">↺ LOOP — SCORE BELOW TARGET</span>
        </div>
        <div class="lb-stem-r"></div>
      </div>
    </div>
    <!-- Active banner -->
    <div class="active-banner" id="active-banner" style="display:none">
      <div class="banner-field">RUN ID<span id="bp-id">--</span></div>
      <div class="banner-field">MODEL<span id="bp-model">--</span></div>
      <div class="banner-field">STAGE<span id="bp-stage">--</span></div>
      <div class="banner-field">ITERATION<span id="bp-iter">--</span></div>
      <div class="banner-field">SCORE<span id="bp-score">--</span></div>
      <div class="banner-field" style="flex:1">
        PROGRESS
        <div class="prog-track"><div class="prog-fill" id="bp-prog" style="width:0%"></div></div>
      </div>
    </div>
  </div>

  <!-- Two columns: Config + Events -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">

    <!-- Launch Config -->
    <div class="pl-section">
      <div class="pl-section-title">Pipeline Configuration</div>
      <div class="cfg-grid" style="margin-bottom:10px">
        <div class="cfg-group"><label>Base Model</label><input id="pl-model" type="text" placeholder="e.g. llama3-8b"></div>
        <div class="cfg-group"><label>Backend</label><select id="pl-backend"><option>vLLM</option><option>Ollama</option><option>Bedrock</option></select></div>
        <div class="cfg-group"><label>Node</label><select id="pl-node"><option value="spark">SPARK-BOB</option><option value="linux">LINUX-DSKTP</option></select></div>
      </div>
      <div class="cfg-grid" style="margin-bottom:10px">
        <div class="cfg-group"><label>Eval Suite</label><input id="pl-suite" type="text" value="hard_15"></div>
        <div class="cfg-group"><label>Target Score %</label><input id="pl-target" type="number" value="80" min="1" max="100"></div>
        <div class="cfg-group"><label>Max Iterations</label><input id="pl-maxiter" type="number" value="3" min="1"></div>
      </div>
      <div class="cfg-grid" style="margin-bottom:10px">
        <div class="cfg-group"><label>LoRA Rank</label><input id="pl-rank" type="number" value="16" min="1"></div>
        <div class="cfg-group"><label>Epochs / Iter</label><input id="pl-epochs" type="number" value="3" min="1"></div>
        <div class="cfg-group"><label>Learning Rate</label><input id="pl-lr" type="text" value="0.0002"></div>
      </div>
      <div class="cfg-grid g2" style="margin-bottom:14px">
        <div class="cfg-group"><label>Data Gen Count / Iter</label><input id="pl-dgcount" type="number" value="200" min="1"></div>
        <div class="cfg-group"><label>Data Domain</label><input id="pl-domain" type="text" placeholder="e.g. IAM, S3"></div>
      </div>
      <button class="bcom-btn" onclick="launchPipeline()" style="width:100%">▶ Launch Pipeline</button>
      <div id="pl-output" style="margin-top:10px;font-size:12px;color:var(--muted);font-family:monospace">—</div>
    </div>

    <!-- Live Events -->
    <div class="pl-section">
      <div class="pl-section-title">
        Live Events
        <button class="bcom-btn bcom-btn-sm" onclick="clearLog()">CLEAR</button>
      </div>
      <div class="ev-log" id="ev-log">
        <div class="ev-log-line"><span class="ev-time">--:--:--</span>Pipeline module ready</div>
      </div>
    </div>
  </div>

  <!-- Training Loss Chart -->
  <div class="pl-section">
    <div class="pl-section-title">Training Loss</div>
    <div class="loss-chart-wrap">
      <canvas id="loss-chart"></canvas>
    </div>
  </div>

  <!-- Run History -->
  <div class="pl-section">
    <div class="pl-section-title">Run History</div>
    <div style="overflow-x:auto">
      <table class="pl-table">
        <thead>
          <tr><th>Run ID</th><th>Model</th><th>Backend</th><th>Suite</th><th>Iters</th><th>Score</th><th>Target</th><th>Status</th><th>Duration</th><th></th></tr>
        </thead>
        <tbody id="run-history-body">
          <tr><td colspan="10" style="text-align:center;color:var(--muted);padding:20px">No pipeline runs yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="../bcom.js?v=5"></script>
<script>
window.BCOM = window.BCOM || {};
BCOM.apiBase = '';

var _runs = [];
var _activeId = null;
var _sse = null;
var _lossData = { labels: [], datasets: [] };
var _lossChart = null;
var _lossIter = 1;

var STAGES     = ['st-data','st-train','st-deploy','st-eval','st-check'];
var ARROWS     = ['arr-0','arr-1','arr-2','arr-3'];
var STAGE_MAP  = { datagen:0, 'data-gen':0, data:0, finetune:1, train:1, training:1, deploy:2, eval:3, check:4, complete:4 };

/* ── Toast ─────────────────────────────────────────────── */
function toast(msg, type) {
  var t = document.createElement('div');
  t.className = 'bcom-toast' + (type === 'err' ? ' bcom-toast-err' : type === 'ok' ? ' bcom-toast-ok' : '');
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(function(){ t.remove(); }, 3500);
}

/* ── Log ────────────────────────────────────────────────── */
function logEvent(msg, cls) {
  var el = document.getElementById('ev-log');
  var t  = new Date().toLocaleTimeString();
  var div = document.createElement('div');
  div.className = 'ev-log-line' + (cls ? ' ' + cls : '');
  div.innerHTML = '<span class="ev-time">' + t + '</span>' + esc(msg);
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

window.clearLog = function() { document.getElementById('ev-log').innerHTML = ''; };

/* ── Stage visuals ──────────────────────────────────────── */
function setStage(idx, iterNum, maxIter, score) {
  STAGES.forEach(function(id, i) {
    var el = document.getElementById(id);
    var cls = i < idx ? ' done' : i === idx ? ' active' : '';
    el.className = 'stage-card' + cls;
  });
  ARROWS.forEach(function(id, i) {
    document.getElementById(id).className = 'stage-conn' + (i < idx ? ' lit' : '');
  });
  var badge = document.getElementById('iter-badge');
  if (iterNum !== undefined) {
    badge.textContent = 'ITER ' + iterNum + ' / ' + (maxIter || '?');
    badge.className = 'iter-badge lit';
  }
  var lb = document.getElementById('loop-row');
  lb.className = 'loop-back' + (iterNum > 1 && idx === 0 ? ' lit' : '');
}

function resetStages() {
  STAGES.forEach(function(id) { document.getElementById(id).className = 'stage-card'; });
  ARROWS.forEach(function(id) { document.getElementById(id).className = 'stage-conn'; });
  STAGES.forEach(function(id) {
    var lv = document.getElementById('live-' + id.replace('st-',''));
    if (lv) lv.textContent = '—';
  });
  document.getElementById('iter-badge').textContent = 'ITER — / —';
  document.getElementById('iter-badge').className = 'iter-badge';
  document.getElementById('loop-row').className = 'loop-back';
  document.getElementById('active-banner').style.display = 'none';
  document.getElementById('btn-cancel').style.display = 'none';
}

function setLive(stageKey, text) {
  var idx = STAGE_MAP[stageKey.toLowerCase()] || 0;
  var id  = STAGES[idx];
  var lv  = document.getElementById('live-' + id.replace('st-',''));
  if (lv) lv.textContent = text;
}

/* ── Chart ──────────────────────────────────────────────── */
function initLossChart() {
  var ctx = document.getElementById('loss-chart').getContext('2d');
  _lossChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 300 },
      plugins: {
        legend: { labels: { color: '#888', font: { size: 11 } } },
        tooltip: { backgroundColor: '#1a1a1a', borderColor: '#333', borderWidth: 1, titleColor: '#ccc', bodyColor: '#ccc' }
      },
      scales: {
        x: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,.04)' } },
        y: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,.04)' } }
      }
    }
  });
}

function pushLossPoint(step, loss, iterNum) {
  var iterKey = 'iter ' + iterNum;
  var ds = _lossChart.data.datasets.find(function(d){ return d.label === iterKey; });
  if (!ds) {
    var colors = ['rgba(180,90,20,1)','rgba(80,140,220,1)','rgba(60,180,100,1)','rgba(220,80,80,1)'];
    var c = colors[(_lossChart.data.datasets.length) % colors.length];
    ds = { label: iterKey, data: [], borderColor: c, backgroundColor: c.replace('1)','0.08)'),
           borderWidth: 1.5, pointRadius: 2, tension: 0.3 };
    _lossChart.data.datasets.push(ds);
    // Keep labels synced
    var maxLen = Math.max.apply(null, _lossChart.data.datasets.map(function(d){ return d.data.length; }));
    _lossChart.data.labels = Array.from({ length: maxLen + 1 }, function(_, i){ return 'step ' + (i * 10); });
  }
  ds.data.push(loss);
  var maxLen = Math.max.apply(null, _lossChart.data.datasets.map(function(d){ return d.data.length; }));
  _lossChart.data.labels = Array.from({ length: maxLen }, function(_, i){ return 'step ' + (i * 10); });
  _lossChart.update('none');
}

/* ── SSE ────────────────────────────────────────────────── */
function openSSE(pipelineId) {
  if (_sse) { _sse.close(); _sse = null; }
  var url = BCOM.apiBase + '/api/pipeline/' + encodeURIComponent(pipelineId) + '/events';
  try {
    _sse = new EventSource(url);
    _sse.onmessage = function(e) {
      try { handleEvent(JSON.parse(e.data)); } catch(_) {}
    };
    _sse.addEventListener('stage_update', function(e) {
      try { handleEvent(JSON.parse(e.data)); } catch(_) {}
    });
    _sse.addEventListener('training_update', function(e) {
      try { handleEvent(JSON.parse(e.data)); } catch(_) {}
    });
    _sse.addEventListener('pipeline_end', function(e) {
      try { handleEvent(JSON.parse(e.data)); onPipelineEnd(); } catch(_) {}
    });
    _sse.onerror = function() { logEvent('SSE connection lost — falling back to polling', 'warn'); };
  } catch(e) { logEvent('SSE not available: ' + e.message, 'warn'); }
}

function handleEvent(ev) {
  var type  = ev.type || ev.event_type || '';
  var stage = ev.stage || ev.current_stage || '';
  var msg   = ev.message || ev.msg || '';
  var iter  = ev.iteration || ev.iter || 1;
  var loss  = ev.loss;
  var score = ev.score;

  if (msg) logEvent('[' + type + '] ' + msg, type === 'error' ? 'err' : 'info');

  if (stage) {
    var idx = STAGE_MAP[stage.toLowerCase()];
    if (idx !== undefined) {
      setStage(idx, iter, undefined, score);
      setLive(stage, msg || stage);
      document.getElementById('bp-stage').textContent = stage.toUpperCase();
      document.getElementById('bp-iter').textContent  = iter;
    }
  }
  if (typeof loss === 'number') {
    pushLossPoint(ev.step || 0, loss, iter);
  }
  if (typeof score === 'number') {
    document.getElementById('bp-score').textContent = score.toFixed ? score.toFixed(1) + '%' : score + '%';
  }
}

function onPipelineEnd() {
  if (_sse) { _sse.close(); _sse = null; }
  _activeId = null;
  resetStages();
  pollRuns();
  toast('Pipeline finished', 'ok');
}

/* ── Launch ─────────────────────────────────────────────── */
window.launchPipeline = function() {
  var model   = document.getElementById('pl-model').value.trim();
  var backend = document.getElementById('pl-backend').value;
  var node    = document.getElementById('pl-node').value;
  var suite   = document.getElementById('pl-suite').value.trim() || 'hard_15';
  var target  = parseInt(document.getElementById('pl-target').value)  || 80;
  var maxiter = parseInt(document.getElementById('pl-maxiter').value) || 3;
  var rank    = parseInt(document.getElementById('pl-rank').value)    || 16;
  var epochs  = parseInt(document.getElementById('pl-epochs').value)  || 3;
  var lr      = document.getElementById('pl-lr').value.trim()         || '0.0002';
  var dgcount = parseInt(document.getElementById('pl-dgcount').value) || 200;
  var domain  = document.getElementById('pl-domain').value.trim()     || 'general';
  if (!model) { toast('Base Model required', 'err'); return; }

  var body = { model_id: model, backend: backend, node: node, eval_suite: suite,
               target_score: target / 100, max_iterations: maxiter,
               lora_rank: rank, epochs: epochs, learning_rate: parseFloat(lr),
               datagen_count: dgcount, domain: domain };

  fetch(BCOM.apiBase + '/api/pipeline/start', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  }).then(function(r){ return r.json(); })
    .then(function(d) {
      var id = d.pipeline_id || d.id || d.run_id || '?';
      _activeId = id;
      document.getElementById('pl-output').textContent = '[' + new Date().toLocaleTimeString() + '] ' + id + ' launched';
      document.getElementById('active-banner').style.display = 'flex';
      document.getElementById('bp-id').textContent    = id.slice(0, 12);
      document.getElementById('bp-model').textContent = model;
      document.getElementById('bp-stage').textContent = 'STARTING';
      document.getElementById('bp-iter').textContent  = '1 / ' + maxiter;
      document.getElementById('bp-score').textContent = '—';
      document.getElementById('btn-cancel').style.display = '';
      setStage(0, 1, maxiter);
      logEvent('Pipeline launched: ' + id, 'info');
      openSSE(id);
    })
    .catch(function(e) { toast('Launch failed: ' + e.message, 'err'); });
};

/* ── Cancel ─────────────────────────────────────────────── */
window.cancelActivePipeline = function() {
  if (!_activeId) return;
  if (!confirm('Cancel pipeline ' + _activeId + '?')) return;
  fetch(BCOM.apiBase + '/api/pipeline/' + encodeURIComponent(_activeId) + '/cancel', { method: 'POST' })
    .then(function(){ toast('Pipeline cancelled', 'ok'); onPipelineEnd(); })
    .catch(function(e){ toast('Cancel failed: ' + e.message, 'err'); });
};

window.cancelRun = function(id, e) {
  e.stopPropagation();
  if (!confirm('Cancel ' + id + '?')) return;
  fetch(BCOM.apiBase + '/api/pipeline/' + encodeURIComponent(id) + '/cancel', { method: 'POST' })
    .then(function(){ toast('Cancelled', 'ok'); setTimeout(pollRuns, 1000); })
    .catch(function(){ toast('Cancel failed', 'err'); });
};

/* ── Run history ────────────────────────────────────────── */
function pollRuns() {
  fetch(BCOM.apiBase + '/api/pipeline/', { cache: 'no-store' })
    .then(function(r){ return r.json(); })
    .then(function(data) {
      _runs = Array.isArray(data) ? data : (data.pipelines || data.runs || data.items || []);
      renderRuns();
      // sync active state from server
      var active = _runs.find(function(r){ return r.status === 'running' || r.status === 'queued'; });
      if (active && !_activeId) {
        _activeId = active.pipeline_id || active.id;
        document.getElementById('active-banner').style.display = 'flex';
        document.getElementById('bp-id').textContent    = _activeId.slice(0,12);
        document.getElementById('bp-model').textContent = active.model_id || active.model || '—';
        document.getElementById('btn-cancel').style.display = '';
        openSSE(_activeId);
      }
      document.getElementById('pl-last-refresh').textContent = 'updated ' + new Date().toLocaleTimeString();
    })
    .catch(function() {});
}

function renderRuns() {
  var tbody = document.getElementById('run-history-body');
  if (!_runs.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:20px">No pipeline runs yet</td></tr>';
    return;
  }
  tbody.innerHTML = _runs.slice(0, 50).map(function(r) {
    var id     = r.pipeline_id || r.id || '?';
    var model  = r.model_id || r.model || '—';
    var back   = r.backend || '—';
    var suite  = r.eval_suite || r.suite || '—';
    var iters  = r.iterations_completed || r.iter || '—';
    var score  = typeof r.final_score === 'number' ? (r.final_score * 100).toFixed(1) + '%'
               : typeof r.score === 'number' ? r.score + '%' : '—';
    var target = typeof r.target_score === 'number' ? (r.target_score * 100).toFixed(0) + '%'
               : r.target ? r.target + '%' : '—';
    var status = (r.status || 'unknown').toLowerCase();
    var dur    = r.duration_s ? r.duration_s.toFixed(0) + 's' : (r.duration || '—');
    var canCancel = status === 'running' || status === 'queued';
    return '<tr>' +
      '<td style="font-family:monospace;font-size:11px;color:var(--orange-dark)">' + esc(id.slice(0,12)) + '</td>' +
      '<td>' + esc(model) + '</td>' +
      '<td style="color:var(--muted)">' + esc(back) + '</td>' +
      '<td style="color:var(--muted)">' + esc(suite) + '</td>' +
      '<td>' + esc(String(iters)) + '</td>' +
      '<td style="font-weight:600">' + score + '</td>' +
      '<td style="color:var(--muted)">' + target + '</td>' +
      '<td><span class="run-status ' + status + '">' + status + '</span></td>' +
      '<td style="color:var(--muted)">' + dur + '</td>' +
      '<td>' + (canCancel ? '<button class="bcom-btn bcom-btn-sm bcom-btn-danger" onclick="cancelRun(\'' + esc(id) + '\',event)">CANCEL</button>' : '') + '</td>' +
      '</tr>';
  }).join('');
}

/* ── Active deploy fallback ─────────────────────────────── */
function pollActiveDeploy() {
  if (_activeId) return;
  fetch(BCOM.apiBase + '/api/deploy/active', { cache: 'no-store' })
    .then(function(r){ return r.json(); })
    .then(function(d) {
      if (d && d.status === 'active') {
        document.getElementById('active-banner').style.display = 'flex';
        document.getElementById('bp-id').textContent    = (d.id || '').slice(0, 8);
        document.getElementById('bp-model').textContent = d.model_name || '—';
        document.getElementById('bp-stage').textContent = 'DEPLOY';
        document.getElementById('bp-prog').style.width  = '60%';
        setStage(2);
        document.getElementById('live-deploy').textContent = (d.backend || '?') + ' active';
      }
    }).catch(function(){});
}

/* ── Utils ──────────────────────────────────────────────── */
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ── Init ───────────────────────────────────────────────── */
function startPolling() {
  initLossChart();
  pollRuns();
  pollActiveDeploy();
  setInterval(pollRuns, 15000);
  setInterval(function(){ if (!_activeId) pollActiveDeploy(); }, 10000);
}

document.addEventListener('DOMContentLoaded', startPolling);
</script>
</body>
</html>
