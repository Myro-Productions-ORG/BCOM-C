<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BCOM-C — Resources</title>
<script>
  (function(){
    var t=localStorage.getItem("bcom-theme")||"dark";
    document.documentElement.setAttribute("data-theme",t);
    try { var raw=localStorage.getItem("bcom-theme-vars"); if(raw){ var vars=JSON.parse(raw); Object.keys(vars).forEach(function(k){ document.documentElement.style.setProperty(k,vars[k]); }); } } catch(_) {}
  })();
</script>
<link rel="stylesheet" href="../bcom.css?v=3" />
<style>
  /* ── Hero chips ───────────────────────────────────────────────────── */
  .hero-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:18px; }
  .hero-chip { flex:1; min-width:110px; padding:10px 14px; border:1px solid #1a0e05; background:#090603; }
  .hero-chip-label { font-size:9px; letter-spacing:2px; color:#666; margin-bottom:4px; }
  .hero-chip-val { font-size:20px; font-weight:700; color:var(--orange); letter-spacing:1px; }
  .hero-chip-sub { font-size:9px; color:#555; margin-top:2px; letter-spacing:1px; }

  /* ── Generic table ────────────────────────────────────────────────── */
  .res-table { width:100%; border-collapse:collapse; font-size:12px; letter-spacing:.5px; }
  .res-table th { background:#0e0a06; color:#ccc; font-weight:600; letter-spacing:1.5px; padding:7px 10px; text-align:left; border-bottom:1px solid #1e1008; }
  .res-table td { padding:7px 10px; border-bottom:1px solid #120b04; vertical-align:middle; color:#ccc; }
  .res-table tr:hover td { background:#0e0905; }
  .res-table .empty { text-align:center; color:#2a2a2a; padding:24px; letter-spacing:2px; }

  /* ── Status pills ─────────────────────────────────────────────────── */
  .spill { display:inline-block; font-size:9px; letter-spacing:1.5px; padding:2px 7px; border:1px solid; }
  .spill.up      { color:#27ae60; border-color:#27ae60; }
  .spill.running { color:#27ae60; border-color:#27ae60; }
  .spill.down    { color:#e74c3c; border-color:#e74c3c; }
  .spill.stopped { color:#e74c3c; border-color:#e74c3c; }
  .spill.paused  { color:#f39c12; border-color:#f39c12; }
  .spill.restarting { color:var(--orange); border-color:var(--orange-dark); }
  .spill.loaded  { color:#27ae60; border-color:#27ae60; }
  .spill.cached  { color:var(--orange); border-color:var(--orange-dark); }
  .spill.avail   { color:#444; border-color:#333; }

  /* ── Action buttons in tables ─────────────────────────────────────── */
  .ctr-btn { font-size:9px; letter-spacing:1.5px; padding:2px 8px; background:#0e0905; border:1px solid #2a1508; color:#aaa; cursor:pointer; }
  .ctr-btn:hover { border-color:var(--orange-dark); color:var(--orange); }
  .ctr-btn.danger { border-color:#3a1010; color:#e74c3c; }
  .ctr-btn.danger:hover { border-color:#e74c3c; }
  .btn-row { display:flex; gap:4px; }

  /* ── Storage bars ─────────────────────────────────────────────────── */
  .stor-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .stor-node { padding:12px; border:1px solid #1a0e05; background:#090603; }
  .stor-hdr  { font-size:11px; letter-spacing:2px; color:var(--orange-dark); margin-bottom:10px; font-weight:700; }
  .stor-row  { margin-bottom:8px; }
  .stor-label{ font-size:10px; letter-spacing:1px; color:#ccc; display:flex; justify-content:space-between; margin-bottom:3px; }
  .stor-track{ background:#0e0905; height:6px; }
  .stor-fill { height:6px; background:var(--orange-dark); transition:width .6s; }
  .stor-fill.warn   { background:#f39c12; }
  .stor-fill.danger { background:#e74c3c; }

  /* ── Pull model form ──────────────────────────────────────────────── */
  .form-grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px; }
  .form-grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }
  .form-grp label { display:block; font-size:9px; letter-spacing:1.5px; color:#777; margin-bottom:4px; }
  .form-grp input, .form-grp select { width:100%; box-sizing:border-box; }
  .pull-out { font-size:11px; letter-spacing:1px; color:#555; margin-top:6px; min-height:18px; }

  /* ── Section header with actions ──────────────────────────────────── */
  .card-hdr-row { display:flex; align-items:center; justify-content:space-between; }
  .card-hdr-row .filters { display:flex; gap:6px; align-items:center; }
  .card-hdr-row select { font-size:10px; padding:2px 8px; width:auto; }
  .card-hdr-row input[type=text] { font-size:10px; padding:2px 8px; width:140px; }

  /* ── Log panel override ───────────────────────────────────────────── */
  .log-panel { margin-top:16px; }
</style>
</head>
<body>

<nav class="bcom-nav">
  <span class="bcom-nav-brand">BCOM-C</span>
  <div class="bcom-nav-links">
    <a href="pipeline.html">PIPELINE</a>
    <a href="data-gen.html">DATAGEN</a>
    <a href="analytics.html">ANALYTICS</a>
    <a href="coordinator.html">COORDINATOR</a>
    <a href="datasets.html">DATASETS</a>
    <a href="evals.html">EVALS</a>
    <a href="models.html">MODELS</a>
    <a href="monitor.html">MONITOR</a>
    <a href="deploy.html">DEPLOY</a>
    <a href="resources.html" class="active">RESOURCES</a>
    <a href="reports.html">REPORTS</a>
    <a href="settings.html">⚙</a>
  </div>
</nav>

<div class="main">

  <!-- ── Hero chips ──────────────────────────────────────────────────── -->
  <div class="hero-row">
    <div class="hero-chip">
      <div class="hero-chip-label">CONTAINERS</div>
      <div class="hero-chip-val" id="h-containers">--</div>
      <div class="hero-chip-sub">TOTAL</div>
    </div>
    <div class="hero-chip">
      <div class="hero-chip-label">RUNNING</div>
      <div class="hero-chip-val" id="h-running">--</div>
      <div class="hero-chip-sub">CONTAINERS</div>
    </div>
    <div class="hero-chip">
      <div class="hero-chip-label">SERVICES</div>
      <div class="hero-chip-val" id="h-services">--</div>
      <div class="hero-chip-sub">ACTIVE</div>
    </div>
    <div class="hero-chip">
      <div class="hero-chip-label">MODELS LOADED</div>
      <div class="hero-chip-val" id="h-models">--</div>
      <div class="hero-chip-sub">IN MEMORY</div>
    </div>
    <div class="hero-chip">
      <div class="hero-chip-label">STORAGE USED</div>
      <div class="hero-chip-val" id="h-storage">--</div>
      <div class="hero-chip-sub">SPARK-BOB ROOT</div>
    </div>
    <div class="hero-chip">
      <div class="hero-chip-label">API STATUS</div>
      <div class="hero-chip-val" id="h-api" style="font-size:13px;letter-spacing:1px">--</div>
      <div class="hero-chip-sub">BOBSPARK-APIS</div>
    </div>
  </div>

  <div class="info-grid">

    <!-- ── CONTAINERS ─────────────────────────────────────────────────── -->
    <div class="info-card">
      <div class="info-card-hdr card-hdr-row">
        <span>Containers</span>
        <div class="filters">
          <select class="form-select" id="ctr-filter" onchange="renderContainers()">
            <option value="all">ALL</option>
            <option value="running">RUNNING</option>
            <option value="stopped">STOPPED</option>
          </select>
          <button class="ctr-btn" onclick="refreshContainers()">⟳ REFRESH</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table class="res-table">
          <thead>
            <tr><th>NAME</th><th>IMAGE</th><th>STATUS</th><th>PORTS</th><th>NODE</th><th>UPTIME</th><th>ACTIONS</th></tr>
          </thead>
          <tbody id="ctr-body">
            <tr><td colspan="7" class="empty">LOADING…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ── SERVICES ───────────────────────────────────────────────────── -->
    <div class="info-card">
      <div class="info-card-hdr card-hdr-row">
        <span>Services</span>
        <div class="filters">
          <button class="ctr-btn" onclick="refreshServices()">⟳ REFRESH</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table class="res-table">
          <thead>
            <tr><th>SERVICE</th><th>STATUS</th><th>PORT</th><th>NODE</th><th>PID</th><th>UPTIME</th><th>ACTIONS</th></tr>
          </thead>
          <tbody id="svc-body">
            <tr><td colspan="7" class="empty">LOADING…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ── MODEL REGISTRY ─────────────────────────────────────────────── -->
    <div class="info-card">
      <div class="info-card-hdr card-hdr-row">
        <span>Model Registry</span>
        <div class="filters">
          <input type="text" class="form-input" id="reg-search" placeholder="SEARCH…" oninput="renderRegistry()" style="font-size:10px;padding:2px 8px;width:130px;" />
          <select class="form-select" id="reg-filter-node" onchange="renderRegistry()">
            <option value="all">ALL NODES</option>
            <option value="spark">SPARK-BOB</option>
            <option value="linux">LINUX-DSKTP</option>
          </select>
          <select class="form-select" id="reg-filter-status" onchange="renderRegistry()">
            <option value="all">ALL STATUS</option>
            <option value="loaded">LOADED</option>
            <option value="cached">CACHED</option>
            <option value="avail">AVAILABLE</option>
          </select>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table class="res-table">
          <thead>
            <tr><th>MODEL</th><th>TYPE</th><th>SIZE</th><th>BACKEND</th><th>NODE</th><th>QUANT</th><th>STATUS</th><th>ACTIONS</th></tr>
          </thead>
          <tbody id="reg-body">
            <tr><td colspan="8" class="empty">LOADING…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ── PULL MODEL ─────────────────────────────────────────────────── -->
    <div class="info-card">
      <div class="info-card-hdr">Pull / Register Model</div>
      <div class="form-body">
        <div class="form-grid-3">
          <div class="form-grp">
            <label>Model ID or Path</label>
            <input class="form-input" id="pull-id" type="text" placeholder="e.g. mistral:7b-q4" />
          </div>
          <div class="form-grp">
            <label>Backend</label>
            <select class="form-select" id="pull-backend">
              <option>Ollama</option><option>vLLM</option><option>HuggingFace</option>
            </select>
          </div>
          <div class="form-grp">
            <label>Node</label>
            <select class="form-select" id="pull-node">
              <option value="spark">SPARK-BOB</option>
              <option value="linux">LINUX-DSKTP</option>
            </select>
          </div>
        </div>
        <div class="form-grid-3">
          <div class="form-grp">
            <label>Quantization</label>
            <select class="form-select" id="pull-quant">
              <option>Q4_K_M</option><option>Q5_K_M</option><option>Q8_0</option><option>FP16</option><option>FP32</option>
            </select>
          </div>
          <div class="form-grp">
            <label>Tag / Version</label>
            <input class="form-input" id="pull-tag" type="text" placeholder="latest" />
          </div>
          <div class="form-grp" style="display:flex;align-items:flex-end;">
            <button class="form-submit" style="margin-top:0;width:100%" onclick="submitPull()">↓ PULL</button>
          </div>
        </div>
        <div class="pull-out" id="pull-output">—</div>
      </div>
    </div>

    <!-- ── STORAGE ─────────────────────────────────────────────────────── -->
    <div class="info-card">
      <div class="info-card-hdr card-hdr-row">
        <span>Storage</span>
        <div class="filters">
          <button class="ctr-btn" onclick="refreshStorage()">⟳ REFRESH</button>
        </div>
      </div>
      <div class="stor-grid">
        <div class="stor-node">
          <div class="stor-hdr">SPARK-BOB</div>
          <div class="stor-row">
            <div class="stor-label"><span>MODELS</span><span id="stor-spark-models">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-spark-models" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>DATASETS</span><span id="stor-spark-data">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-spark-data" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>CHECKPOINTS</span><span id="stor-spark-ckpt">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-spark-ckpt" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>ROOT FS</span><span id="stor-spark-root">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-spark-root" style="width:0%"></div></div>
          </div>
        </div>
        <div class="stor-node">
          <div class="stor-hdr">LINUX-DSKTP</div>
          <div class="stor-row">
            <div class="stor-label"><span>UBDRIVE</span><span id="stor-linux-ubdrive">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-linux-ubdrive" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>DATASETS</span><span id="stor-linux-data">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-linux-data" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>CHECKPOINTS</span><span id="stor-linux-ckpt">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-linux-ckpt" style="width:0%"></div></div>
          </div>
          <div class="stor-row">
            <div class="stor-label"><span>ROOT FS</span><span id="stor-linux-root">-- / --</span></div>
            <div class="stor-track"><div class="stor-fill" id="sf-linux-root" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /info-grid -->

  <div class="log-panel" id="log">
    <div class="log-line"><span class="log-time">--:--:--</span><span class="log-msg info">RESOURCES ready — polling containers, services, models, storage.</span></div>
  </div>

</div><!-- /main -->

<script src="../bcom.js?v=5"></script>
<script>
window.BCOM = window.BCOM || {};
BCOM.apiBase = '';

// ── State ──────────────────────────────────────────────────────────────
var _containers = [];
var _services   = [];
var _models     = [];

// ── Helpers ────────────────────────────────────────────────────────────
function setText(id, v) {
  var el = document.getElementById(id);
  if (el) el.textContent = v;
}

function logLine(msg, cls) {
  var panel = document.getElementById('log');
  if (!panel) return;
  var now = new Date();
  var ts  = now.toTimeString().split(' ')[0];
  var div = document.createElement('div');
  div.className = 'log-line';
  div.innerHTML = '<span class="log-time">' + ts + '</span>'
                + '<span class="log-msg ' + (cls||'info') + '">' + msg + '</span>';
  panel.appendChild(div);
  panel.scrollTop = panel.scrollHeight;
  while (panel.children.length > 120) panel.removeChild(panel.firstChild);
}

function pillHtml(status) {
  var s = (status || 'unknown').toLowerCase();
  var cls = s;
  if (s === 'active' || s === 'online') cls = 'up';
  return '<span class="spill ' + cls + '">' + s.toUpperCase() + '</span>';
}

function setStorBar(fillId, labelId, usedGb, totalGb) {
  if (!totalGb) return;
  var pct = Math.min(100, Math.round(usedGb / totalGb * 100));
  var fill = document.getElementById(fillId);
  if (fill) {
    fill.style.width = pct + '%';
    fill.className   = 'stor-fill' + (pct >= 90 ? ' danger' : pct >= 75 ? ' warn' : '');
  }
  var lbl = document.getElementById(labelId);
  if (lbl) lbl.textContent = usedGb.toFixed(1) + ' / ' + totalGb.toFixed(1) + ' GB';
}

// ── Containers ─────────────────────────────────────────────────────────
function renderContainers() {
  var filter = document.getElementById('ctr-filter').value;
  var list   = _containers;
  if (filter !== 'all') list = list.filter(function(c) {
    var s = (c.status || c.state || '').toLowerCase();
    return filter === 'running' ? s === 'running' : s !== 'running';
  });
  var tb = document.getElementById('ctr-body');
  if (!list.length) {
    tb.innerHTML = '<tr><td colspan="7" class="empty">NO CONTAINERS</td></tr>';
    return;
  }
  tb.innerHTML = list.map(function(c) {
    var name   = c.name   || c.Names   || c.id || '--';
    var image  = c.image  || c.Image   || '--';
    var status = c.status || c.State   || 'unknown';
    var ports  = c.ports  || c.Ports   || '';
    var node   = c.node   || 'SPARK-BOB';
    var uptime = c.uptime || c.Started || '--';
    if (Array.isArray(name))  name  = name.join(', ').replace(/^\//, '');
    if (Array.isArray(ports)) ports = ports.map(function(p){ return p.PublicPort || ''; }).filter(Boolean).join(', ');
    var id = c.id || c.Id || '';
    return '<tr>'
      + '<td style="color:var(--orange-dark);font-weight:600">' + name + '</td>'
      + '<td style="color:#888;font-size:10px">' + image + '</td>'
      + '<td>' + pillHtml(status) + '</td>'
      + '<td style="color:#777;font-size:10px">' + (ports || '—') + '</td>'
      + '<td style="color:#666;font-size:10px">' + node + '</td>'
      + '<td style="color:#666;font-size:10px">' + uptime + '</td>'
      + '<td><div class="btn-row">'
      + '<button class="ctr-btn" onclick="containerAction(\'' + id + '\',\'start\')">START</button>'
      + '<button class="ctr-btn" onclick="containerAction(\'' + id + '\',\'stop\')">STOP</button>'
      + '<button class="ctr-btn" onclick="containerAction(\'' + id + '\',\'restart\')">RESTART</button>'
      + '</div></td>'
      + '</tr>';
  }).join('');
}

async function refreshContainers() {
  try {
    var res = await fetch('/api/system/containers', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    var d = await res.json();
    _containers = d.containers || d || [];
    var running = _containers.filter(function(c){ return (c.status||c.state||'').toLowerCase()==='running'; }).length;
    setText('h-containers', _containers.length);
    setText('h-running', running);
    renderContainers();
  } catch (err) {
    logLine('Containers error: ' + err.message, 'warn');
    document.getElementById('ctr-body').innerHTML = '<tr><td colspan="7" class="empty">API UNAVAILABLE</td></tr>';
  }
}

async function containerAction(id, action) {
  if (!id) return;
  try {
    logLine('Container ' + action + ': ' + id, 'info');
    var res = await fetch('/api/system/containers/' + id + '/' + action, { method: 'POST' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    logLine('Container ' + action + ' OK', 'info');
    setTimeout(refreshContainers, 1200);
  } catch (err) {
    logLine('Container action failed: ' + err.message, 'warn');
  }
}

// ── Services ───────────────────────────────────────────────────────────
function renderServices() {
  var tb = document.getElementById('svc-body');
  if (!_services.length) {
    tb.innerHTML = '<tr><td colspan="7" class="empty">NO SERVICES</td></tr>';
    return;
  }
  tb.innerHTML = _services.map(function(s) {
    var name   = s.name    || s.service  || '--';
    var status = s.status  || s.state    || 'unknown';
    var port   = s.port    || s.Port     || '--';
    var node   = s.node    || 'SPARK-BOB';
    var pid    = s.pid     || '--';
    var uptime = s.uptime  || '--';
    return '<tr>'
      + '<td style="color:var(--orange-dark);font-weight:600">' + name + '</td>'
      + '<td>' + pillHtml(status) + '</td>'
      + '<td style="color:#777;font-size:10px">' + port + '</td>'
      + '<td style="color:#666;font-size:10px">' + node + '</td>'
      + '<td style="color:#666;font-size:10px">' + pid + '</td>'
      + '<td style="color:#666;font-size:10px">' + uptime + '</td>'
      + '<td><div class="btn-row">'
      + '<button class="ctr-btn" onclick="serviceAction(\'' + name + '\',\'start\')">START</button>'
      + '<button class="ctr-btn" onclick="serviceAction(\'' + name + '\',\'stop\')">STOP</button>'
      + '<button class="ctr-btn" onclick="serviceAction(\'' + name + '\',\'restart\')">RESTART</button>'
      + '</div></td>'
      + '</tr>';
  }).join('');
}

async function refreshServices() {
  try {
    var res = await fetch('/api/system/services', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    var d = await res.json();
    _services = d.services || d || [];
    var active = _services.filter(function(s){ var st=(s.status||s.state||'').toLowerCase(); return st==='up'||st==='running'||st==='active'; }).length;
    setText('h-services', active);
    renderServices();
  } catch (err) {
    logLine('Services error: ' + err.message, 'warn');
    document.getElementById('svc-body').innerHTML = '<tr><td colspan="7" class="empty">API UNAVAILABLE</td></tr>';
  }
}

async function serviceAction(name, action) {
  if (!name) return;
  try {
    logLine('Service ' + action + ': ' + name, 'info');
    var res = await fetch('/api/system/services/' + encodeURIComponent(name) + '/' + action, { method: 'POST' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    logLine('Service ' + action + ' OK: ' + name, 'info');
    setTimeout(refreshServices, 1200);
  } catch (err) {
    logLine('Service action failed: ' + err.message, 'warn');
  }
}

// ── Model Registry ─────────────────────────────────────────────────────
function renderRegistry() {
  var fn  = document.getElementById('reg-filter-node').value;
  var fs  = document.getElementById('reg-filter-status').value;
  var srch = (document.getElementById('reg-search').value || '').toLowerCase();
  var m   = _models.slice();
  if (fn !== 'all')  m = m.filter(function(x){ return x.node === fn; });
  if (fs !== 'all')  m = m.filter(function(x){ return x.status === fs; });
  if (srch) m = m.filter(function(x){ return x.id.toLowerCase().indexOf(srch) >= 0; });
  var tb = document.getElementById('reg-body');
  if (!m.length) {
    tb.innerHTML = '<tr><td colspan="8" class="empty">NO MODELS</td></tr>';
    return;
  }
  tb.innerHTML = m.map(function(x) {
    return '<tr>'
      + '<td style="color:var(--orange-dark);font-weight:600">' + x.id + '</td>'
      + '<td>' + x.type + '</td>'
      + '<td>' + x.size + '</td>'
      + '<td>' + x.backend + '</td>'
      + '<td style="color:#777;font-size:10px">' + (x.node==='spark'?'SPARK-BOB':'LINUX-DSKTP') + '</td>'
      + '<td style="color:#999;font-size:10px">' + x.quant + '</td>'
      + '<td>' + pillHtml(x.status) + '</td>'
      + '<td><div class="btn-row">'
      + '<button class="ctr-btn" onclick="modelAction(\'' + x.id + '\',\'load\')">LOAD</button>'
      + '<button class="ctr-btn danger" onclick="modelAction(\'' + x.id + '\',\'remove\')">RM</button>'
      + '</div></td>'
      + '</tr>';
  }).join('');
}

async function refreshModels() {
  try {
    var res = await fetch('/api/models/', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    var d   = await res.json();
    var raw = d.models || (Array.isArray(d) ? d : []);
    _models = raw.map(function(m) {
      return {
        id:      m.name || m.model || m.id || '--',
        type:    ((m.details && m.details.family) || 'LLM').toUpperCase(),
        size:    m.size ? (m.size / 1e9).toFixed(1) + ' GB' : '--',
        backend: 'Ollama',
        node:    'spark',
        quant:   (m.details && m.details.quantization_level) || '--',
        status:  'loaded',
      };
    });
    var loaded = _models.filter(function(m){ return m.status === 'loaded'; }).length;
    setText('h-models', loaded);
    renderRegistry();
  } catch (err) {
    logLine('Models error: ' + err.message, 'warn');
    document.getElementById('reg-body').innerHTML = '<tr><td colspan="8" class="empty">API UNAVAILABLE</td></tr>';
  }
}

function modelAction(id, action) {
  logLine('Model ' + action + ': ' + id, 'info');
}

// ── Pull model ─────────────────────────────────────────────────────────
async function submitPull() {
  var id  = (document.getElementById('pull-id').value || '').trim();
  var bk  = document.getElementById('pull-backend').value;
  var nd  = document.getElementById('pull-node').value;
  var qt  = document.getElementById('pull-quant').value;
  var tag = (document.getElementById('pull-tag').value || 'latest').trim();
  var out = document.getElementById('pull-output');
  if (!id) { out.textContent = 'ERROR: Model ID required.'; out.style.color = '#e74c3c'; return; }
  out.textContent = 'Pulling ' + id + ':' + tag + ' via ' + bk + ' on ' + (nd==='spark'?'SPARK-BOB':'LINUX-DSKTP') + '…';
  out.style.color = 'var(--orange-dark)';
  try {
    var res = await fetch('/api/models/pull', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: id, tag: tag, backend: bk, node: nd, quantization: qt }),
    });
    var d = await res.json();
    if (res.ok) {
      out.textContent = 'Pull started: ' + (d.message || d.status || 'OK');
      out.style.color = '#27ae60';
      logLine('Pull queued: ' + id, 'info');
      setTimeout(refreshModels, 3000);
    } else {
      out.textContent = 'ERROR: ' + (d.detail || d.error || 'Unknown error');
      out.style.color = '#e74c3c';
    }
  } catch (err) {
    out.textContent = 'ERROR: ' + err.message;
    out.style.color = '#e74c3c';
  }
}

// ── Storage ────────────────────────────────────────────────────────────
async function refreshStorage() {
  try {
    var [storRes, linuxRes] = await Promise.all([
      fetch('/api/system/storage',      { cache: 'no-store' }),
      fetch('/api/system/linux/stats',  { cache: 'no-store' }),
    ]);

    if (storRes.ok) {
      var stor = await storRes.json();
      var sp   = stor.spark || stor || {};
      if (sp.models)      setStorBar('sf-spark-models', 'stor-spark-models', sp.models.used_gb,      sp.models.total_gb);
      if (sp.datasets)    setStorBar('sf-spark-data',   'stor-spark-data',   sp.datasets.used_gb,    sp.datasets.total_gb);
      if (sp.checkpoints) setStorBar('sf-spark-ckpt',   'stor-spark-ckpt',   sp.checkpoints.used_gb, sp.checkpoints.total_gb);
      if (sp.root)        setStorBar('sf-spark-root',   'stor-spark-root',   sp.root.used_gb,        sp.root.total_gb);
      if (sp.root)        setText('h-storage', sp.root.used_gb.toFixed(1) + ' GB');
    }

    if (linuxRes.ok) {
      var lx = await linuxRes.json();
      var d  = lx.disk || {};
      if (d.ubdrive) setStorBar('sf-linux-ubdrive', 'stor-linux-ubdrive', d.ubdrive.used_gb, d.ubdrive.total_gb);
      if (d.ubdrive) setStorBar('sf-linux-data',    'stor-linux-data',    d.ubdrive.used_gb, d.ubdrive.total_gb);
      if (d.ckpts)   setStorBar('sf-linux-ckpt',    'stor-linux-ckpt',    d.ckpts.used_gb,   d.ckpts.total_gb);
      if (d.root)    setStorBar('sf-linux-root',    'stor-linux-root',    d.root.used_gb,    d.root.total_gb);
    }
  } catch (err) {
    logLine('Storage error: ' + err.message, 'warn');
  }
}

// ── API health chip ────────────────────────────────────────────────────
async function refreshApiHealth() {
  try {
    var res = await fetch('/api/health', { cache: 'no-store' });
    var el  = document.getElementById('h-api');
    if (res.ok) {
      el.textContent = 'ONLINE';
      el.style.color = '#27ae60';
    } else {
      el.textContent = 'ERROR';
      el.style.color = '#e74c3c';
    }
  } catch (_) {
    var el = document.getElementById('h-api');
    el.textContent = 'OFFLINE';
    el.style.color = '#e74c3c';
  }
}

// ── Poll all ───────────────────────────────────────────────────────────
function pollAll() {
  refreshContainers();
  refreshServices();
  refreshModels();
  refreshStorage();
  refreshApiHealth();
}

// Initial load
pollAll();

// Staggered intervals
setInterval(refreshContainers,   12000);
setInterval(refreshServices,     15000);
setInterval(refreshModels,       20000);
setInterval(refreshStorage,      30000);
setInterval(refreshApiHealth,     8000);
</script>
</body>
</html>
