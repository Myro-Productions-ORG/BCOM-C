<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BCOM-C â€” Orchestrator</title>
<script>
  (function(){
    var t=localStorage.getItem("bcom-theme")||"dark";
    document.documentElement.setAttribute("data-theme",t);
    try { var raw=localStorage.getItem("bcom-theme-vars"); if(raw){ var vars=JSON.parse(raw); Object.keys(vars).forEach(function(k){ document.documentElement.style.setProperty(k,vars[k]); }); } } catch(_) {}
  })();
</script>
<link rel="stylesheet" href="../assets/css/bcom.css?v=3" />
<style>

/* â”€â”€ ORCHESTRATOR PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orch-layout {
  flex: 1;
  display: grid;
  grid-template-columns: 260px 1fr 260px;
  grid-template-rows: 1fr 160px;
  gap: 10px;
  padding: 10px 14px;
  min-height: 0;
}

/* â”€â”€ SHARED PANEL BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orch-panel {
  background: var(--bg-panel);
  border: 2px solid var(--border-dim);
  border-radius: 2px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.orch-panel-hdr {
  background: #3b3b3b;
  border-bottom: 1px solid var(--border-dim);
  padding: 5px 12px;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2px;
  color: var(--orange-dark);
  text-transform: uppercase;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.orch-panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 10px 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.orch-panel-body::-webkit-scrollbar { width: 3px; }
.orch-panel-body::-webkit-scrollbar-track { background: var(--bg-deep); }
.orch-panel-body::-webkit-scrollbar-thumb { background: var(--orange-deep); }

/* â”€â”€ LEFT: DEPLOY PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orch-deploy-panel { grid-row: 1/2; grid-column: 1/2; }

.deploy-sep {
  font-size: 7px; color: #ccc; letter-spacing: 2px; text-transform: uppercase;
  border-bottom: 1px solid #4a4a4a; padding-bottom: 3px; margin-bottom: 2px;
}
.orch-label { font-size: 7px; color: #3a3a3a; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 1px; }

.orch-input {
  background: #3b3b3b; border: 1px solid var(--border-dim);
  color: var(--orange); font-family: 'Courier New', monospace;
  font-size: 9px; padding: 4px 8px; width: 100%; box-sizing: border-box;
}
.orch-input:focus { outline: none; border-color: var(--orange); }
.orch-input::placeholder { color: #999; }

.orch-textarea {
  background: #3b3b3b; border: 1px solid var(--border-dim);
  color: var(--orange); font-family: 'Courier New', monospace;
  font-size: 9px; padding: 5px 8px; width: 100%; box-sizing: border-box;
  resize: vertical; min-height: 60px; max-height: 110px; line-height: 1.5;
}
.orch-textarea:focus { outline: none; border-color: var(--orange); }
.orch-textarea::placeholder { color: #999; }
/* â”€â”€ QUEUE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.oc-queue-empty {
  font-size: 7px; color: #888; letter-spacing: 1px; text-align: center;
  padding: 6px 0; text-transform: uppercase;
}
.oc-queue-item {
  background: #3b3b3b; border: 1px solid #5a5a5a; border-radius: 1px;
  padding: 5px 8px; display: flex; flex-direction: column; gap: 2px;
}
.oc-queue-item:hover { border-color: var(--orange-dark); }
.oc-qi-top { display: flex; align-items: center; gap: 6px; }
.oc-qi-pos {
  background: var(--orange-deep); color: var(--orange); font-size: 8px;
  font-weight: 700; width: 16px; height: 16px; display: flex;
  align-items: center; justify-content: center; flex-shrink: 0;
  border: 1px solid var(--orange-dark);
}
.oc-qi-task {
  font-size: 8px; color: #ddd; flex: 1;
  overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
}
.oc-qi-meta { display: flex; gap: 8px; }
.oc-qi-meta span { font-size: 6px; color: #888; letter-spacing: 1px; text-transform: uppercase; }
.oc-qi-mode {
  font-size: 6px; letter-spacing: 1px; padding: 1px 5px;
  border: 1px solid #5a5a5a; color: #7fb3cc; text-transform: uppercase;
  flex-shrink: 0;
}
.oc-qi-mode.strands { color: #a78bfa; border-color: #7c3aed; }

/* â”€â”€ STEP LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.oc-step-log {
  display: flex; flex-direction: column; gap: 3px; font-family: 'Courier New', monospace;
  max-height: 160px; overflow-y: auto;
}
.oc-step-log::-webkit-scrollbar { width: 2px; }
.oc-step-log::-webkit-scrollbar-thumb { background: var(--orange-deep); }
.oc-step-item {
  font-size: 7px; letter-spacing: 0.3px; padding: 3px 6px;
  border-left: 2px solid #4a4a4a; color: #bbb; line-height: 1.4;
  word-break: break-all;
}
.oc-step-item.node_update  { border-color: var(--orange-dark); color: var(--orange); }
.oc-step-item.text_chunk   { border-color: #5a8a5a; color: #aed4ae; }
.oc-step-item.status       { border-color: #7fb3cc; color: #7fb3cc; }
.oc-step-item.error        { border-color: #e74c3c; color: #e74c3c; }
.oc-step-item.usage        { border-color: #555; color: #888; }
.oc-step-empty {
  font-size: 7px; color: #888; letter-spacing: 1px; text-align: center;
  padding: 6px 0; text-transform: uppercase;
}


.orch-select {
  background: #3b3b3b; border: 1px solid var(--border-dim);
  color: var(--orange); font-family: 'Courier New', monospace;
  font-size: 9px; padding: 4px 8px; width: 100%; box-sizing: border-box;
}
.orch-select:focus { outline: none; border-color: var(--orange); }
.orch-select option { background: #3b3b3b; }

.orch-file-zone {
  border: 1px dashed #252525; padding: 7px 8px; cursor: pointer;
  text-align: center; font-size: 7px; letter-spacing: 1.5px; color: #888;
  transition: all 0.2s; position: relative; border-radius: 1px;
}
.orch-file-zone:hover, .orch-file-zone.drag-over {
  border-color: var(--orange-dark); color: var(--orange-dark);
}
.orch-file-zone input[type="file"] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer;
  width: 100%; height: 100%;
}
.orch-attach-list { display: flex; flex-direction: column; gap: 2px; }
.orch-attach-item {
  display: flex; align-items: center; justify-content: space-between;
  font-size: 7px; letter-spacing: 0.5px; color: #7fb3cc;
  padding: 1px 2px;
}
.orch-attach-rm { color: #e74c3c; cursor: pointer; font-size: 9px; line-height: 1; }
.orch-attach-rm:hover { color: #ff6b6b; }

.orch-submit {
  background: var(--orange-deep); border: 1.5px solid var(--orange);
  color: var(--orange); font-family: 'Courier New', monospace;
  font-size: 9px; letter-spacing: 2px; padding: 7px 12px;
  cursor: pointer; width: 100%; text-transform: uppercase;
}
.orch-submit:hover { background: var(--orange-dark); color: #fff; }

/* â”€â”€ CENTER: CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orch-canvas-wrap {
  grid-row: 1/2; grid-column: 2/3;
  background: var(--bg-panel); border: 2px solid var(--border-dim);
  border-radius: 2px; position: relative; overflow: hidden;
  display: flex; flex-direction: column;
}
.orch-canvas-hdr {
  background: #3b3b3b; border-bottom: 1px solid var(--border-dim);
  padding: 5px 12px; display: flex; align-items: center;
  justify-content: space-between; flex-shrink: 0;
}
.orch-canvas-title {
  font-size: 9px; font-weight: 700; letter-spacing: 2px;
  color: var(--orange-dark); text-transform: uppercase;
}
.orch-canvas-badge {
  font-size: 7px; letter-spacing: 1.5px;
  border: 1px solid; padding: 1px 6px;
}
.orch-canvas-controls { display: flex; gap: 6px; }
.orch-ctrl-btn {
  background: #3b3b3b; border: 1px solid var(--border-dim); color: #bbb;
  font-family: 'Courier New', monospace; font-size: 8px; letter-spacing: 1px;
  padding: 2px 8px; cursor: pointer; text-transform: uppercase;
}
.orch-ctrl-btn:hover { color: var(--orange); border-color: var(--orange-dark); }
.orch-ctrl-btn.active-ctrl { color: var(--orange); border-color: var(--orange); }

#orch-canvas { flex: 1; width: 100%; display: block; cursor: default; }

#orch-tooltip {
  position: absolute; pointer-events: none;
  background: #3b3b3b; border: 1px solid var(--orange-dark);
  padding: 6px 10px; font-size: 8px; letter-spacing: 1px;
  color: var(--orange); display: none; z-index: 50; min-width: 140px;
}
#orch-tooltip .tt-name  { font-weight: 700; margin-bottom: 3px; letter-spacing: 2px; }
#orch-tooltip .tt-row   { color: #bbb; display: flex; justify-content: space-between; gap: 16px; }
#orch-tooltip .tt-val   { color: #888; }

.orch-legend {
  position: absolute; bottom: 10px; left: 12px; display: flex; gap: 14px;
}
.legend-item { display: flex; align-items: center; gap: 5px; font-size: 7px; color: #ccc; letter-spacing: 1px; }
.legend-dot  { width: 7px; height: 7px; border-radius: 50%; }

/* â”€â”€ RIGHT: STATUS CARDS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orch-cards-panel { grid-row: 1/2; grid-column: 3/4; }

.oc-section-label {
  font-size: 7px; color: #ccc; letter-spacing: 2px; text-transform: uppercase;
  border-bottom: 1px solid #4a4a4a; padding-bottom: 3px; margin-bottom: 4px;
}

/* Orchestrator card */
.oc-orch-card {
  background: #3b3b3b; border: 1px solid var(--orange-dark); border-radius: 1px;
  padding: 8px 10px; display: flex; flex-direction: column; gap: 5px;
}
.oc-orch-hdr { display: flex; align-items: center; gap: 6px; }
.oc-orch-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  background: #333; transition: background 0.4s, box-shadow 0.4s;
}
.oc-orch-dot.idle    { background: #333; }
.oc-orch-dot.active  { background: #2ecc71; box-shadow: 0 0 6px #2ecc71; animation: pulse 1.5s infinite; }
.oc-orch-dot.running { background: #f39c12; box-shadow: 0 0 6px #f39c12; animation: pulse 1s infinite; }
.oc-orch-name { font-size: 11px; font-weight: 700; letter-spacing: 2.5px; color: var(--orange); flex: 1; }
.oc-orch-chip {
  font-size: 6px; letter-spacing: 1.5px; padding: 1px 6px;
  border: 1px solid #5a5a5a; color: #ddd; text-transform: uppercase;
  transition: color 0.3s, border-color 0.3s;
}
.oc-orch-chip.running { color: #f39c12; border-color: #f39c12; }
.oc-orch-chip.active  { color: #2ecc71; border-color: #2ecc71; }
.oc-model-label {
  font-size: 8px; color: #7fb3cc; letter-spacing: 1.5px;
  padding-left: 14px; font-weight: 700;
}
.oc-orch-stats { display: flex; gap: 12px; padding-left: 14px; }
.oc-stat { display: flex; flex-direction: column; gap: 1px; }
.oc-stat-label { font-size: 6px; color: #888; letter-spacing: 1px; }
.oc-stat-val   { font-size: 9px; color: #bbb; }

/* Agent card */
.oc-agent-card {
  background: #3b3b3b; border: 1px solid #0e2030; border-radius: 1px;
  padding: 6px 10px; display: flex; flex-direction: column; gap: 3px;
  transition: opacity 0.5s, transform 0.3s;
  animation: cardIn 0.35s cubic-bezier(0.16,1,0.3,1);
}
.oc-agent-card.despawning { opacity: 0; transform: translateY(-4px); }
@keyframes cardIn {
  from { opacity: 0; transform: translateY(-6px); }
  to   { opacity: 1; transform: translateY(0); }
}
.oc-agent-hdr  { display: flex; align-items: center; gap: 6px; }
.oc-agent-dot  {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
  transition: background 0.3s, box-shadow 0.3s;
}
.oc-agent-dot.idle  { background: #1e2e3a; }
.oc-agent-dot.busy  { background: #f39c12; box-shadow: 0 0 5px #f39c12; animation: pulse 1s infinite; }
.oc-agent-dot.active{ background: #2ecc71; box-shadow: 0 0 5px #2ecc71; animation: pulse 1.5s infinite; }
.oc-agent-name { font-size: 9px; font-weight: 700; letter-spacing: 1.5px; color: #7fb3cc; flex: 1; }
.oc-agent-chip {
  font-size: 6px; letter-spacing: 1px; padding: 1px 5px;
  border: 1px solid #0e2030; color: #1e3a50;
}
.oc-agent-chip.busy  { color: #f39c12; border-color: #f39c12; }
.oc-agent-chip.active{ color: #2ecc71; border-color: #2ecc71; }
.oc-agent-sub { font-size: 7px; color: #1e3a50; letter-spacing: 1px; padding-left: 12px; }

/* Node hardware mini */
.oc-hw-row {
  display: flex; justify-content: space-between;
  font-size: 8px; letter-spacing: 0.5px; line-height: 1.8;
}
.oc-hw-key { color: #ccc; }
.oc-hw-val { color: #bbb; }

/* â”€â”€ BOTTOM TASK PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orch-task-panel {
  grid-row: 2/3; grid-column: 1/4;
  background: var(--bg-panel); border: 2px solid var(--border-dim);
  border-radius: 2px; display: flex; flex-direction: column; overflow: hidden;
}
.orch-task-hdr {
  background: #3b3b3b; border-bottom: 1px solid var(--border-dim);
  padding: 5px 12px; display: flex; align-items: center;
  justify-content: space-between; font-size: 9px; font-weight: 700;
  letter-spacing: 2px; color: var(--orange-dark); flex-shrink: 0;
}
.orch-task-hdr-right { display: flex; align-items: center; gap: 8px; }
#orch-task-count {
  font-size: 7px; color: var(--orange); background: var(--orange-deep);
  border: 1px solid var(--orange-dark); padding: 1px 6px; letter-spacing: 1px;
}
.orch-task-table-wrap { flex: 1; overflow-y: auto; }
.orch-task-table-wrap::-webkit-scrollbar       { width: 4px; }
.orch-task-table-wrap::-webkit-scrollbar-track { background: var(--bg-deep); }
.orch-task-table-wrap::-webkit-scrollbar-thumb { background: var(--orange-deep); }
.orch-task-table { width: 100%; border-collapse: collapse; font-size: 8px; }
.orch-task-table th {
  color: #ccc; border-bottom: 1px solid #4a4a4a; padding: 4px 10px;
  text-align: left; letter-spacing: 1px; font-weight: 700; background: #3b3b3b;
  white-space: nowrap; position: sticky; top: 0; z-index: 1;
}
.orch-task-table td {
  padding: 4px 10px; color: #bbb; border-bottom: 1px solid #0f0f0f;
  white-space: nowrap; letter-spacing: 0.5px;
}
.orch-task-table tbody tr:hover td { background: #3b3b3b; }
.task-id    { color: #ccc; font-family: 'Courier New', monospace; }
.task-name  { color: var(--orange) !important; font-weight: 700; }
.task-agent { color: #7fb3cc !important; }
.task-empty { padding: 20px; text-align: center; color: #999; font-size: 8px; letter-spacing: 2px; }
.task-status-chip {
  display: inline-block; font-size: 6px; letter-spacing: 1.5px;
  padding: 1px 6px; text-transform: uppercase;
}
.task-status-chip.running  { color: #f39c12; border: 1px solid #f39c12; }
.task-status-chip.complete { color: #2ecc71; border: 1px solid #2ecc71; }
.task-status-chip.queued   { color: #ddd;    border: 1px solid #5a5a5a; }
.task-status-chip.error    { color: #e74c3c; border: 1px solid #e74c3c; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-title">BCOM-C</div>
  <div class="topbar-right">
    <a class="nav-btn" href="../index.html"><span class="nav-arrow">&#8592;</span> DASHBOARD</a>
    <a class="nav-btn" href="data-gen.html">DATA GEN</a>
    <a class="nav-btn" href="pipeline.html">PIPELINE</a>
    <a class="nav-btn" href="resources.html">RESOURCES</a>
    <a class="nav-btn" href="reports.html">REPORTS</a>
    <a class="nav-btn active" href="orchestrator.html">ORCHESTRATOR</a>
    <a class="cog-btn" href="settings.html" title="Settings">âš™</a>
    <div class="timestamp"><span id="clock">--:--:--</span>&nbsp;&nbsp;<span id="datestamp">----/--/--</span></div>
  </div>
</div>

<!-- ACTION BAR -->
<div class="actionbar">
  <button class="action-btn danger" onclick="triggerAction('HALT ALL AGENTS')">HALT ALL AGENTS</button>
  <button class="action-btn danger" onclick="triggerAction('RESET ORCHESTRATOR')">RESET ORCHESTRATOR</button>
  <button class="action-btn" onclick="deployTask()">DEPLOY TASK</button>
  <button class="action-btn" onclick="triggerAction('EXPORT GRAPH')">EXPORT GRAPH</button>
</div>

<!-- MAIN ORCHESTRATOR LAYOUT -->
<div class="orch-layout">

  <!-- LEFT: DEPLOY + PROMPT + FILE -->
  <div class="orch-panel orch-deploy-panel">
    <div class="orch-panel-hdr">Deploy Task</div>
    <div class="orch-panel-body">
      <div class="deploy-sep">Task</div>
      <div class="orch-label">Name</div>
      <input class="orch-input" id="task-name-input" type="text" placeholder="e.g. debug agent loop..." />
      <div class="orch-label">Prompt / Instructions</div>
      <textarea class="orch-textarea" id="task-prompt-input" placeholder="Describe what you want BOB AI and agents to do..."></textarea>
      <div class="orch-label">Attach Files</div>
      <div class="orch-file-zone" id="file-drop-zone">
        <input type="file" id="task-file-input" multiple />
        <span id="file-zone-label">&#128206; CLICK OR DROP FILES</span>
      </div>
      <div class="orch-attach-list" id="attach-list"></div>
      <div class="deploy-sep" style="margin-top:2px;">Config</div>
      <div class="orch-label">Task Type</div>
      <select class="orch-select" id="task-type-select">
        <option value="code">CODE GENERATION</option>
        <option value="debug">DEBUG / INSPECT</option>
        <option value="research">RESEARCH</option>
        <option value="pipeline">PIPELINE RUN</option>
        <option value="eval">EVALUATION</option>
        <option value="custom">CUSTOM</option>
      </select>
      <div class="orch-label">Assign Agent</div>
      <select class="orch-select" id="task-agent-select">
        <option value="auto">AUTO (Router)</option>
        <option value="code">CODE AGENT</option>
        <option value="doc">DOC AGENT</option>
        <option value="analysis">ANALYSIS AGENT</option>
        <option value="debug">DEBUG AGENT</option>
        <option value="search">SEARCH AGENT</option>
      </select>
      <div class="orch-label">Orchestrator Model</div>
      <select class="orch-select" id="task-model-select">
        <option value="claude-haiku-4-5-20251001">HAIKU 4.5 â€” fast</option>
        <option value="claude-sonnet-4-5-20250929">SONNET 4.5 â€” balanced</option>
        <option value="claude-sonnet-4-6">SONNET 4.6 â€” latest</option>
        <option value="claude-opus-4-5-20251101">OPUS 4.5 â€” powerful</option>
        <option value="claude-opus-4-6">OPUS 4.6 â€” flagship</option>
        <option value="local">LOCAL (llama3.3:70b)</option>
      </select>
      <div class="orch-label">Priority</div>
      <select class="orch-select" id="task-priority-select">
        <option value="normal">NORMAL</option>
        <option value="high">HIGH</option>
        <option value="critical">CRITICAL</option>
        <option value="low">LOW</option>
      </select>
      <div class="orch-label" style="margin-top:4px;">Orchestrator Backend</div>
      <select class="orch-select" id="orch-mode-select">
        <option value="langgraph">LangGraph (Default)</option>
        <option value="strands">Strands Agents SDK</option>
      </select>
      <div style="font-size:6px;color:#888;letter-spacing:1px;margin-bottom:4px;">
        STRANDS: Claude sub-agents via Anthropic API
      </div>
      <button class="orch-submit" onclick="deployTask()">&#9654; DISPATCH TASK</button>
    </div>
  </div>

  <!-- CENTER: AGENT NETWORK CANVAS -->
  <div class="orch-canvas-wrap">
    <div class="orch-canvas-hdr">
      <div style="display:flex;align-items:center;gap:10px;">
        <span class="orch-canvas-title">Agent Network</span>
        <span class="orch-canvas-badge" id="net-status-badge" style="color:#ccc;border-color:#5a5a5a;">IDLE</span>
      </div>
      <div class="orch-canvas-controls">
        <button class="orch-ctrl-btn active-ctrl" id="btn-view-tree" onclick="setView('tree')">TREE</button>
        <button class="orch-ctrl-btn" id="btn-view-flow" onclick="setView('flow')">FLOW</button>
        <button class="orch-ctrl-btn" onclick="resetCanvas()">RESET</button>
      </div>
    </div>
    <canvas id="orch-canvas"></canvas>
    <div id="orch-tooltip">
      <div class="tt-name" id="tt-name">NODE</div>
      <div class="tt-row"><span>STATUS</span><span class="tt-val" id="tt-status">--</span></div>
      <div class="tt-row"><span>TASKS</span><span class="tt-val" id="tt-tasks">--</span></div>
      <div class="tt-row"><span>TYPE</span><span class="tt-val" id="tt-type">--</span></div>
    </div>
    <div class="orch-legend">
      <div class="legend-item"><div class="legend-dot" style="background:#DA7756;box-shadow:0 0 5px #DA7756;"></div>ORCHESTRATOR</div>
      <div class="legend-item"><div class="legend-dot" style="background:#7fb3cc;box-shadow:0 0 5px #7fb3cc;"></div>AGENT</div>
      <div class="legend-item"><div class="legend-dot" style="background:#2ecc71;box-shadow:0 0 4px #2ecc71;"></div>ACTIVE</div>
    </div>
  </div>

  <!-- RIGHT: STATUS CARDS -->
  <div class="orch-panel orch-cards-panel">
    <div class="orch-panel-hdr">Agent Status</div>
    <div class="orch-panel-body" id="cards-body">
      <div class="oc-section-label">Orchestrator</div>
      <div class="oc-orch-card">
        <div class="oc-orch-hdr">
          <div class="oc-orch-dot idle" id="bob-dot"></div>
          <div class="oc-orch-name">BOB AI</div>
          <div class="oc-orch-chip" id="bob-chip">IDLE</div>
        </div>
        <div class="oc-model-label" id="bob-model-label">HAIKU 4.5</div>
        <div class="oc-orch-stats">
          <div class="oc-stat"><div class="oc-stat-label">RUNNING</div><div class="oc-stat-val" id="lc-running">--</div></div>
          <div class="oc-stat"><div class="oc-stat-label">TOTAL</div><div class="oc-stat-val" id="lc-total">--</div></div>
          <div class="oc-stat"><div class="oc-stat-label">SUCCESS</div><div class="oc-stat-val" id="lc-success">--</div></div>
        </div>
        <div class="oc-orch-stats">
          <div class="oc-stat"><div class="oc-stat-label">TOKENS</div><div class="oc-stat-val" id="lc-tokens">--</div></div>
          <div class="oc-stat"><div class="oc-stat-label">AVG DUR</div><div class="oc-stat-val" id="lc-avgdur">--</div></div>
        </div>
      </div>
      <div class="oc-section-label" id="agents-section-label" style="display:none;">Active Agents</div>
      <div id="agent-cards-list"></div>
      <div class="oc-section-label" style="margin-top:4px;">Node Hardware</div>
      <div style="font-size:7px;color:#2a2a2a;letter-spacing:1.5px;margin-bottom:2px;">SPARK-BOB (DGX)</div>
      <div class="oc-hw-row"><span class="oc-hw-key">CPU</span><span class="oc-hw-val" id="orch-spark-cpu">--%</span></div>
      <div class="oc-hw-row"><span class="oc-hw-key">GPU</span><span class="oc-hw-val" id="orch-spark-gpu">--%</span></div>
      <div class="oc-hw-row"><span class="oc-hw-key">VRAM</span><span class="oc-hw-val" id="orch-spark-vram">--</span></div>
      <div class="oc-hw-row"><span class="oc-hw-key">TEMP</span><span class="oc-hw-val" id="orch-spark-temp">--</span></div>
      <div class="oc-hw-row"><span class="oc-hw-key">UPTIME</span><span class="oc-hw-val" id="orch-spark-uptime">--</span></div>
      <div style="font-size:7px;color:#2a2a2a;letter-spacing:1.5px;margin:6px 0 2px;">LINUX-DSKTP</div>
      <div class="oc-hw-row"><span class="oc-hw-key">CPU</span><span class="oc-hw-val" id="orch-linux-cpu">--%</span></div>
      <div class="oc-hw-row"><span class="oc-hw-key">RAM</span><span class="oc-hw-val" id="orch-linux-ram">--</span></div>
      <div class="oc-hw-row"><span class="oc-hw-key">TEMP</span><span class="oc-hw-val" id="orch-linux-temp">--</span></div>
      <div class="oc-hw-row"><span class="oc-hw-key">UPTIME</span><span class="oc-hw-val" id="orch-linux-uptime">--</span></div>
      <div class="oc-section-label" style="margin-top:8px;">PENDING QUEUE</div>
      <div id="oc-queue-list">
        <div class="oc-queue-empty">NO QUEUED RUNS</div>
      </div>
      <div class="oc-section-label" style="margin-top:8px;">STEP LOG</div>
      <div style="font-size:6px;color:#888;letter-spacing:1px;margin-bottom:3px;" id="oc-step-run-label">SELECT A RUNNING TASK</div>
      <div class="oc-step-log" id="oc-step-log">
        <div class="oc-step-empty">NO ACTIVE RUN</div>
      </div>
    </div>
  </div>

  <!-- BOTTOM: TASK TABLE -->
  <div class="orch-task-panel">
    <div class="orch-task-hdr">
      <span>Active Tasks &amp; Log</span>
      <div class="orch-task-hdr-right">
        <span id="orch-task-count">0 TASKS</span>
        <button class="orch-ctrl-btn" onclick="clearCompletedTasks()">CLEAR DONE</button>
      </div>
    </div>
    <div class="orch-task-table-wrap">
      <table class="orch-task-table">
        <thead><tr>
          <th>ID</th><th>NAME</th><th>TYPE</th>
          <th>AGENT</th><th>PROGRESS</th><th>PRI</th><th>TIME</th><th>STATUS</th>
        </tr></thead>
        <tbody id="task-tbody">
          <tr><td colspan="8" class="task-empty">NO ACTIVE TASKS â€” DISPATCH A TASK TO BEGIN</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div><!-- end .orch-layout -->

<div class="footer">
  <span>BOB AI // BCOM-C v0.1 â€” ORCHESTRATOR</span>
  <span id="footer-date"></span>
  <span id="footer-status">LANGGRAPH READY</span>
</div>

<script src="../assets/js/bcom.js?v=5"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORCHESTRATOR â€” Dynamic Tree Canvas + Agent Spawn System
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Model label map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MODEL_SHORT = {
  'claude-haiku-4-5-20251001':  'HAIKU 4.5',
  'claude-sonnet-4-5-20250929': 'SONNET 4.5',
  'claude-sonnet-4-6':          'SONNET 4.6',
  'claude-opus-4-5-20251101':   'OPUS 4.5',
  'claude-opus-4-6':            'OPUS 4.6',
  'local':                      'LLAMA 3.3:70B',
};

// â”€â”€ Agent definitions (spawnable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AGENT_DEFS = {
  code:     { label: 'CODE AGENT',     sub: 'Py Â· JS Â· Bash',    color: '#7fb3cc', glow: 'rgba(127,179,204,0.28)' },
  doc:      { label: 'DOC AGENT',      sub: 'Write Â· Format',    color: '#7fb3cc', glow: 'rgba(127,179,204,0.28)' },
  analysis: { label: 'ANALYSIS AGENT', sub: 'Inspect Â· Score',   color: '#a8d8a8', glow: 'rgba(168,216,168,0.25)' },
  debug:    { label: 'DEBUG AGENT',    sub: 'Trace Â· Inspect',   color: '#e8b89a', glow: 'rgba(232,184,154,0.25)' },
  search:   { label: 'SEARCH AGENT',   sub: 'Web Â· Docs Â· RAG',  color: '#c8b0d8', glow: 'rgba(200,176,216,0.25)' },
};

// â”€â”€ BOB AI orchestrator node (always present) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOB = {
  id: 'bob', label: 'BOB AI', sub: 'HAIKU 4.5',
  type: 'orchestrator', status: 'idle', tasks: 0,
  x: 0.5, y: 0.22, radius: 40,
  color: '#DA7756', glow: 'rgba(218,119,86,0.32)',
  alpha: 1,
};

let NODES = [BOB];
let EDGES = [];
const activeAgents = {};   // id â†’ { node, despawning }
const particles    = [];

// â”€â”€ Canvas setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('orch-canvas');
const ctx    = canvas.getContext('2d');
let W = 0, H = 0, tick = 0;
let hoveredNode = null, currentView = 'tree';

function resizeCanvas() {
  const wrap = canvas.parentElement;
  W = wrap.clientWidth;
  H = wrap.clientHeight - 36;
  canvas.width  = W;
  canvas.height = H;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// â”€â”€ Coordinate helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wx(n) { return n.x * W; }
function wy(n) { return n.y * H; }

// â”€â”€ Agent spawn / despawn â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAgentPositions(count) {
  if (count === 0) return [];
  const y = 0.70;
  const maxSpread = 0.76;
  const spacing = Math.min(0.20, maxSpread / Math.max(count, 1));
  const startX = 0.5 - ((count - 1) * spacing) / 2;
  return Array.from({ length: count }, (_, i) => ({ x: startX + i * spacing, y }));
}

function repositionAgents() {
  const ids = Object.keys(activeAgents);
  const positions = getAgentPositions(ids.length);
  ids.forEach((id, i) => {
    activeAgents[id].node.targetX = positions[i].x;
    activeAgents[id].node.targetY = positions[i].y;
  });
}

function spawnAgent(agentId) {
  if (activeAgents[agentId]) {
    // already spawned â€” mark busy
    activeAgents[agentId].node.status = 'busy';
    updateAgentCard(agentId, 'busy');
    return;
  }
  const def = AGENT_DEFS[agentId];
  if (!def) return;

  const node = {
    id: agentId, label: def.label, sub: def.sub,
    type: 'agent', status: 'busy', tasks: 1,
    x: 0.5, y: 0.22, targetX: 0.5, targetY: 0.70,
    radius: 28, color: def.color, glow: def.glow,
    alpha: 0, _spawning: true,
  };
  activeAgents[agentId] = { node, despawning: false };
  NODES.push(node);
  EDGES.push({ from: 'bob', to: agentId, type: 'agent' });
  repositionAgents();

  // Show agents section label
  document.getElementById('agents-section-label').style.display = '';
  addAgentCard(agentId, def, 'busy');
}

function despawnAgent(agentId) {
  const rec = activeAgents[agentId];
  if (!rec) return;
  rec.despawning = true;
  rec.node._spawning = false;
  rec.node.status = 'idle';

  // Fade out card
  const card = document.getElementById('agent-card-' + agentId);
  if (card) {
    card.classList.add('despawning');
    setTimeout(() => card.remove(), 500);
  }

  // Remove node + edge after fade
  setTimeout(() => {
    NODES = NODES.filter(n => n.id !== agentId);
    EDGES = EDGES.filter(e => e.to !== agentId);
    delete activeAgents[agentId];
    repositionAgents();
    if (Object.keys(activeAgents).length === 0) {
      document.getElementById('agents-section-label').style.display = 'none';
    }
  }, 700);
}

function despawnAll() {
  Object.keys(activeAgents).forEach(id => despawnAgent(id));
  BOB.status = 'idle';
  setBobStatus('idle');
}

// â”€â”€ Agent cards (right panel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addAgentCard(id, def, status) {
  const list = document.getElementById('agent-cards-list');
  const card = document.createElement('div');
  card.className = 'oc-agent-card';
  card.id = 'agent-card-' + id;
  card.innerHTML = `
    <div class="oc-agent-hdr">
      <div class="oc-agent-dot ${status}" id="acdot-${id}"></div>
      <div class="oc-agent-name">${def.label}</div>
      <div class="oc-agent-chip ${status}" id="acchip-${id}">${status.toUpperCase()}</div>
    </div>
    <div class="oc-agent-sub">${def.sub}</div>`;
  list.appendChild(card);
}

function updateAgentCard(id, status) {
  const dot  = document.getElementById('acdot-'  + id);
  const chip = document.getElementById('acchip-' + id);
  if (dot)  { dot.className  = 'oc-agent-dot '  + status; }
  if (chip) { chip.className = 'oc-agent-chip ' + status; chip.textContent = status.toUpperCase(); }
}

function setBobStatus(status) {
  const dot  = document.getElementById('bob-dot');
  const chip = document.getElementById('bob-chip');
  const badge = document.getElementById('net-status-badge');
  if (dot)  { dot.className  = 'oc-orch-dot ' + status; }
  if (chip) {
    chip.className = 'oc-orch-chip ' + status;
    chip.textContent = status.toUpperCase();
  }
  if (badge) {
    const isActive = status === 'running' || status === 'active';
    badge.style.color       = isActive ? '#2ecc71' : '#333';
    badge.style.borderColor = isActive ? '#2ecc71' : '#252525';
    badge.textContent       = isActive ? 'RUNNING' : 'IDLE';
  }
  const footer = document.getElementById('footer-status');
  if (footer) footer.textContent = status === 'running' ? 'BOB AI â€” RUNNING' : 'LANGGRAPH READY';
}

// â”€â”€ Model selector sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBobModel() {
  const sel = document.getElementById('task-model-select');
  const short = MODEL_SHORT[sel.value] || sel.value;
  BOB.sub = short;
  const el = document.getElementById('bob-model-label');
  if (el) el.textContent = short;
}
document.getElementById('task-model-select').addEventListener('change', updateBobModel);
updateBobModel();

// â”€â”€ Draw helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawEdge(from, to, alpha) {
  const a = (to.alpha ?? 1) * alpha;
  if (a <= 0.01) return;
  const fx = wx(from), fy = wy(from) + from.radius * 0.7;
  const tx = wx(to),   ty = wy(to)   - to.radius   * 0.7;
  const isActive = to.status === 'busy' || to.status === 'active';
  ctx.save();
  ctx.globalAlpha = isActive ? 0.7 * a : 0.3 * a;
  ctx.strokeStyle = isActive ? '#5a2e14' : '#1e1a16';
  ctx.lineWidth   = isActive ? 2 : 1;
  ctx.setLineDash(isActive ? [] : [3, 8]);
  ctx.beginPath();
  // S-curve bezier
  ctx.moveTo(fx, fy);
  ctx.bezierCurveTo(fx, fy + 40, tx, ty - 40, tx, ty);
  ctx.stroke();
  // Animated dot on active edges
  if (isActive) {
    const t2 = (tick % 80) / 80;
    const bx = bezierPoint(fx, fx, tx, tx, t2);
    const by = bezierPoint(fy, fy + 40, ty - 40, ty, t2);
    ctx.beginPath();
    ctx.arc(bx, by, 2.5, 0, Math.PI * 2);
    ctx.fillStyle = from.color;
    ctx.globalAlpha = 0.8 * a;
    ctx.fill();
  }
  ctx.restore();
}

function bezierPoint(p0, p1, p2, p3, t) {
  const mt = 1 - t;
  return mt*mt*mt*p0 + 3*mt*mt*t*p1 + 3*mt*t*t*p2 + t*t*t*p3;
}

function drawNode(n) {
  // Animate alpha for spawn
  if (n._spawning && (n.alpha ?? 1) < 1) {
    n.alpha = Math.min(1, (n.alpha ?? 0) + 0.045);
    if (n.alpha >= 1) { n.alpha = 1; n._spawning = false; }
  }
  // Animate position for spawn (slide from BOB down)
  if (n.targetX !== undefined) {
    n.x += (n.targetX - n.x) * 0.06;
    n.y += (n.targetY - n.y) * 0.06;
  }
  // Animate alpha for despawn
  if (activeAgents[n.id]?.despawning) {
    n.alpha = Math.max(0, (n.alpha ?? 1) - 0.04);
  }

  const a = n.alpha ?? 1;
  if (a <= 0.01) return;

  const x = wx(n), y = wy(n), r = n.radius;
  const hovered = hoveredNode?.id === n.id;
  const sr = hovered ? r * 1.1 : r;

  // Glow
  const glowR = sr * (hovered ? 2.6 : 2.0);
  const grd = ctx.createRadialGradient(x, y, sr * 0.2, x, y, glowR);
  grd.addColorStop(0, n.glow);
  grd.addColorStop(1, 'transparent');
  ctx.beginPath();
  ctx.arc(x, y, glowR, 0, Math.PI * 2);
  ctx.fillStyle = grd;
  ctx.globalAlpha = a;
  ctx.fill();

  // Status ring
  const statusCol = n.status === 'active' ? '#2ecc71'
                  : n.status === 'busy'   ? '#f39c12'
                  : n.status === 'error'  ? '#e74c3c' : '#2a2a2a';
  ctx.beginPath();
  ctx.arc(x, y, sr + 3, 0, Math.PI * 2);
  ctx.strokeStyle = statusCol;
  ctx.lineWidth = n.status === 'idle' ? 1 : 1.8;
  ctx.globalAlpha = (n.status === 'idle' ? 0.25 : 0.85) * a;
  ctx.stroke();

  // Pulse ring
  if (n.status !== 'idle') {
    const pulseR = sr + 4 + Math.sin(tick * 0.07) * 6;
    ctx.beginPath();
    ctx.arc(x, y, pulseR, 0, Math.PI * 2);
    ctx.strokeStyle = statusCol;
    ctx.lineWidth = 1;
    ctx.globalAlpha = (0.15 + Math.sin(tick * 0.07) * 0.1) * a;
    ctx.stroke();
  }

  // Node fill
  ctx.beginPath();
  ctx.arc(x, y, sr, 0, Math.PI * 2);
  ctx.fillStyle = n.type === 'orchestrator' ? '#444' : '#464e54';
  ctx.globalAlpha = a;
  ctx.fill();
  ctx.strokeStyle = n.color;
  ctx.lineWidth = hovered ? 2.5 : 1.8;
  ctx.stroke();

  // Label
  const fontSize = n.type === 'orchestrator' ? 10 : 8;
  ctx.font = `700 ${fontSize}px "Courier New", monospace`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillStyle = n.color;
  ctx.shadowColor = n.color;
  ctx.shadowBlur = 7;
  ctx.globalAlpha = a;
  ctx.fillText(n.label, x, y - 6);
  ctx.shadowBlur = 0;

  // Sub-label (model name for BOB AI)
  ctx.font = `600 7px "Courier New", monospace`;
  ctx.fillStyle = n.type === 'orchestrator' ? '#c87a5a' : '#7fb3cc';
  ctx.fillText(n.sub, x, y + 6);

  // Task badge
  if (n.tasks > 0) {
    ctx.beginPath();
    ctx.arc(x + sr * 0.65, y - sr * 0.65, 8, 0, Math.PI * 2);
    ctx.fillStyle = '#f39c12';
    ctx.globalAlpha = a;
    ctx.fill();
    ctx.font = `700 7px "Courier New", monospace`;
    ctx.fillStyle = '#000';
    ctx.shadowBlur = 0;
    ctx.fillText(n.tasks, x + sr * 0.65, y - sr * 0.65);
  }

  ctx.globalAlpha = 1;
  ctx.shadowBlur  = 0;
}

// â”€â”€ Render loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  ctx.clearRect(0, 0, W, H);

  // Grid
  ctx.save();
  ctx.strokeStyle = '#686868';
  ctx.lineWidth = 0.5;
  const gs = 44;
  for (let gx = 0; gx < W; gx += gs) { ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,H); ctx.stroke(); }
  for (let gy = 0; gy < H; gy += gs) { ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(W,gy); ctx.stroke(); }
  ctx.restore();

  // Edges
  for (const e of EDGES) {
    const from = NODES.find(n => n.id === e.from);
    const to   = NODES.find(n => n.id === e.to);
    if (from && to) drawEdge(from, to, 1);
  }

  // Nodes
  for (const n of NODES) drawNode(n);

  tick++;
  requestAnimationFrame(render);
}
render();

// â”€â”€ Mouse hover tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
canvas.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const tip = document.getElementById('orch-tooltip');
  hoveredNode = null;
  for (const n of NODES) {
    const dx = mx - wx(n), dy = my - wy(n);
    if (Math.sqrt(dx*dx + dy*dy) < n.radius + 6) { hoveredNode = n; break; }
  }
  if (hoveredNode) {
    document.getElementById('tt-name').textContent   = hoveredNode.label;
    document.getElementById('tt-status').textContent = hoveredNode.status.toUpperCase();
    document.getElementById('tt-tasks').textContent  = hoveredNode.tasks;
    document.getElementById('tt-type').textContent   = hoveredNode.type.toUpperCase();
    tip.style.display = 'block';
    tip.style.left    = (mx + 14) + 'px';
    tip.style.top     = (my - 10) + 'px';
  } else {
    tip.style.display = 'none';
  }
});
canvas.addEventListener('mouseleave', () => {
  document.getElementById('orch-tooltip').style.display = 'none';
  hoveredNode = null;
});

// â”€â”€ View / reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(v) {
  currentView = v;
  document.getElementById('btn-view-tree').classList.toggle('active-ctrl', v === 'tree');
  document.getElementById('btn-view-flow').classList.toggle('active-ctrl', v === 'flow');
}

// â”€â”€ Map SSE agent names â†’ AGENT_DEFS keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AGENT_NODE_MAP = {
  supervisor:     'bob',
  code_agent:     'code',
  doc_agent:      'doc',
  analysis_agent: 'analysis',
  debug_agent:    'debug',
  search_agent:   'search',
  done:           'bob',
};

function _setActiveNode(agentName) {
  const nodeId = AGENT_NODE_MAP[agentName] || agentName;
  if (nodeId === 'bob' || !nodeId) {
    BOB.status = 'busy';
    setBobStatus('running');
    return;
  }
  BOB.status = 'busy';
  setBobStatus('running');
  spawnAgent(nodeId);
}

/* â”€â”€ API base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const API = '';
const _sseConns = {};

// â”€â”€ File attachment handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _attachedFiles = []; // { name, size, content }

const fileInput = document.getElementById('task-file-input');
const fileZone  = document.getElementById('file-drop-zone');

fileInput.addEventListener('change', () => handleFileList(fileInput.files));

fileZone.addEventListener('dragover',  e => { e.preventDefault(); fileZone.classList.add('drag-over'); });
fileZone.addEventListener('dragleave', ()  => fileZone.classList.remove('drag-over'));
fileZone.addEventListener('drop', e => {
  e.preventDefault(); fileZone.classList.remove('drag-over');
  handleFileList(e.dataTransfer.files);
});

async function handleFileList(files) {
  for (const f of files) {
    const content = await readFileText(f);
    _attachedFiles.push({ name: f.name, size: f.size, content: content.slice(0, 60000) });
  }
  renderAttachList();
}

function readFileText(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload  = e => res(e.target.result);
    r.onerror = () => rej(new Error('read error'));
    r.readAsText(file);
  });
}

function renderAttachList() {
  const el = document.getElementById('attach-list');
  if (_attachedFiles.length === 0) {
    el.innerHTML = '';
    document.getElementById('file-zone-label').textContent = 'ðŸ“„ CLICK OR DROP FILES';
    return;
  }
  document.getElementById('file-zone-label').textContent = `${_attachedFiles.length} FILE${_attachedFiles.length>1?'S':''} ATTACHED`;
  el.innerHTML = _attachedFiles.map((f, i) =>
    `<div class="orch-attach-item">
      <span>&#9654; ${f.name}</span>
      <span class="orch-attach-rm" onclick="removeAttach(${i})">&#10005;</span>
    </div>`
  ).join('');
}

function removeAttach(i) {
  _attachedFiles.splice(i, 1);
  renderAttachList();
}

// â”€â”€ Deploy Task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TYPE_LABELS = {
  code:'CODE GEN', debug:'DEBUG', research:'RESEARCH',
  pipeline:'PIPELINE', eval:'EVAL', custom:'CUSTOM',
};
const PRIORITY_COLORS = { low:'#444', normal:'#7fb3cc', high:'#f39c12', critical:'#e74c3c' };
let tasks = [];

async function deployTask() {
  const name      = document.getElementById('task-name-input').value.trim() || 'Unnamed Task';
  const prompt    = document.getElementById('task-prompt-input').value.trim();
  const type      = document.getElementById('task-type-select').value;
  const agentRaw  = document.getElementById('task-agent-select').value;
  const priority  = document.getElementById('task-priority-select').value;
  const modelRaw  = document.getElementById('task-model-select').value;
  const orchModel = modelRaw === 'local' ? null : modelRaw;

  // Build full task description
  let fullTask = name;
  if (prompt) fullTask += '\n\n' + prompt;
  if (_attachedFiles.length > 0) {
    fullTask += '\n\n[Attached files: ' + _attachedFiles.map(f=>f.name).join(', ') + ']\n';
    _attachedFiles.forEach(f => { fullTask += `\n--- ${f.name} ---\n${f.content}\n`; });
  }


  document.getElementById('task-name-input').value = '';
  document.getElementById('task-prompt-input').value = '';
  _attachedFiles = [];
  renderAttachList();

  let runId;
  try {
    const res = await fetch(`${API}/api/runs`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        task: fullTask,
        config: { type, agent: agentRaw, priority, orchestrator_model: orchModel, orchestrator_mode: (document.getElementById('orch-mode-select')||{value:'langgraph'}).value },
        queued: false,
      }),
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    runId = data.run_id;
  } catch (err) {
    return;
  }

  BOB.tasks++;
  setBobStatus('running');

  const task = {
    id: runId, name, type,
    agentId: agentRaw === 'auto' ? 'supervisor' : agentRaw,
    priority, status: 'running', progress: 0,
    queuedAt: Date.now(),
  };
  tasks.push(task);
  renderTaskTable();
  updateTaskCount();
  _streamRun(runId, task);
}

// â”€â”€ SSE stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _streamRun(runId, taskRef) {
  if (_sseConns[runId]) return;
  const es = new EventSource(`${API}/api/runs/${runId}/stream`);
  _sseConns[runId] = es;
  watchRunSteps(runId);

  es.onmessage = (e) => {
    let ev; try { ev = JSON.parse(e.data); } catch { return; }
    const etype = ev.event_type || '', node = ev.node || '', data = ev.data || {};

    if (etype === 'stream_end') {
      es.close(); delete _sseConns[runId];
      const fs = data.status || 'completed';
      if (taskRef) {
        taskRef.status   = fs === 'completed' ? 'complete' : fs === 'failed' ? 'error' : fs;
        taskRef.progress = fs === 'completed' ? 100 : taskRef.progress;
        renderTaskTable();
      }
      BOB.tasks = Math.max(0, BOB.tasks - 1);
      setTimeout(despawnAll, 1200);
      refreshRunHistory(); refreshAnalytics();
      return;
    }

    if (etype === 'node_update') {
      const agent   = data.active_agent || node;
      const snippet = data.snippet  ? ` â€” ${data.snippet.slice(0,80)}`   : '';
      const tokStr  = data.tokens_out != null ? ` [${data.tokens_in||0}â†’${data.tokens_out}tok]` : '';
      if (taskRef && data.iteration != null) {
        taskRef.progress = Math.min(95, Math.round((data.iteration / (data.max_iter || 6)) * 100));
        taskRef.status = 'running'; renderTaskTable();
      }
      _setActiveNode(agent);
    } else if (etype === 'error') {
    } else if (etype === 'status') {
    }
  };

  es.onerror = () => { es.close(); delete _sseConns[runId]; };
}

// â”€â”€ Task table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTaskTable() {
  const tbody = document.getElementById('task-tbody');
  if (tasks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="task-empty">NO ACTIVE TASKS â€” DISPATCH A TASK TO BEGIN</td></tr>';
    return;
  }
  tbody.innerHTML = tasks.slice().reverse().map(t => {
    const sc  = t.status === 'complete' ? 'complete' : t.status === 'error' ? 'error' : t.status === 'running' ? 'running' : 'queued';
    const pc  = PRIORITY_COLORS[t.priority] || '#555';
    const el  = Math.floor((Date.now() - t.queuedAt) / 1000);
    const bar = `<div style="width:100%;background:#3b3b3b;border-radius:1px;height:5px;overflow:hidden">
      <div style="width:${t.progress}%;background:${t.status==='error'?'#e74c3c':'var(--orange)'};height:5px;border-radius:1px;transition:width .4s"></div></div>`;
    const sid = t.id.length > 12 ? t.id.slice(0,8)+'â€¦' : t.id;
    return `<tr onclick="viewRun('${t.id}'); watchRunSteps('${t.id}');" style="cursor:pointer">
      <td class="task-id" title="${t.id}">${sid}</td>
      <td class="task-name">${t.name.slice(0,40)}${t.name.length>40?'â€¦':''}</td>
      <td>${TYPE_LABELS[t.type]||t.type}</td>
      <td class="task-agent">${(AGENT_DEFS[t.agentId]?.label || t.agentId || 'AUTO').replace(' AGENT','')}</td>
      <td>${bar}</td>
      <td style="color:${pc}">${t.priority.toUpperCase()}</td>
      <td style="color:#333">${el}s</td>
      <td><span class="task-status-chip ${sc}">${t.status.toUpperCase()}</span></td>
    </tr>`;
  }).join('');
}

function updateTaskCount() {
  document.getElementById('orch-task-count').textContent = `${tasks.length} TASK${tasks.length !== 1 ? 'S' : ''}`;
}
function clearCompletedTasks() {
  tasks = tasks.filter(t => t.status === 'running');
  renderTaskTable(); updateTaskCount();
}

// â”€â”€ View run detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function viewRun(runId) {
  try {
    const res = await fetch(`${API}/api/runs/${runId}`);
    if (!res.ok) throw new Error('not found');
    const { run, events } = await res.json();
    events.forEach(ev => {
      const d = ev.data || {};
    });
}

// â”€â”€ Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAnalytics() {
  try {
    const res = await fetch(`${API}/api/runs/analytics`);
    if (!res.ok) return;
    const data = await res.json();
    const t = data.totals || {};
    const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    set('lc-running', t.running  ?? '--');
    set('lc-total',   t.total_runs ?? '--');
    set('lc-tokens',  t.total_tokens ? _fmtNum(t.total_tokens) : '--');
    const sr = t.total_runs > 0 ? Math.round((t.completed / t.total_runs) * 100) + '%' : '--';
    set('lc-success', sr);
    set('lc-avgdur',  t.avg_duration_s ? t.avg_duration_s + 's' : '--');
    if (t.running > 0 && BOB.status === 'idle') setBobStatus('running');
  } catch (_) {}
}

function _fmtNum(n) {
  if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
  if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
  return String(n);
}

// â”€â”€ Run history tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshRunHistory() {
  const body = document.getElementById('run-history-body');
  if (!body) return;
  try {
    const res = await fetch(`${API}/api/runs?limit=30`);
    if (!res.ok) throw new Error('fetch failed');
    const { runs } = await res.json();
    if (!runs.length) {
      return;
    }
    const sc = s => ({ completed:'#2ecc71', failed:'#e74c3c', running:'var(--orange)', queued:'#7fb3cc', cancelled:'#888' }[s] || '#555');
    body.innerHTML = runs.map(r => {
      const ts  = r.created_at ? new Date(r.created_at).toLocaleTimeString() : '?';
      const dur = r.duration_s != null ? `${r.duration_s}s` : '--';
      const tok = (r.tokens_in + r.tokens_out) > 0 ? ` ${_fmtNum(r.tokens_in+r.tokens_out)}tok` : '';
        <span style="color:#444">[${ts}]</span>
        <span style="color:${sc(r.status)};margin:0 4px">${r.status.toUpperCase()}</span>
        <span style="color:#888">${r.id.slice(0,8)}</span>
        <span style="color:#bbb;margin:0 4px">${dur}${tok}</span>
        <span style="color:#666">${r.task.slice(0,55)}${r.task.length>55?'â€¦':''}</span>
      </div>`;
    }).join('');
  } catch (err) {
  }
}

    t.classList.toggle('active', t.dataset.term === node));
  ['orch','agent','history'].forEach(n => {
    if (el) el.style.display = n === node ? 'block' : 'none';
  });
    { orch:'orch $', agent:'agent $', history:'hist $' }[node] || 'orch $';
  if (node === 'history') refreshRunHistory();
}

  const d = document.createElement('div');
  const t = new Date().toTimeString().split(' ')[0];
  d.textContent = `[${t}] ${msg}`;
  out.appendChild(d); out.scrollTop = out.scrollHeight;
}
  const d = document.createElement('div');
  const t = new Date().toTimeString().split(' ')[0];
  d.textContent = `[${t}] ${msg}`;
  out.appendChild(d); out.scrollTop = out.scrollHeight;
}


// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function padZ(n) { return n < 10 ? '0'+n : n; }
function tickClock() {
  const d  = new Date();
  const cEl = document.getElementById('clock');
  const dEl = document.getElementById('datestamp');
  const fEl = document.getElementById('footer-date');
  if (cEl) cEl.textContent = `${padZ(d.getHours())}:${padZ(d.getMinutes())}:${padZ(d.getSeconds())}`;
  if (dEl) dEl.textContent = `${d.getFullYear()}/${padZ(d.getMonth()+1)}/${padZ(d.getDate())}`;
  if (fEl) fEl.textContent = d.toDateString();
}
setInterval(tickClock, 1000); tickClock();

// â”€â”€ Node Hardware polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollOrchMetrics() {
  try {
    const res = await fetch('/api/metrics', { cache: 'no-store' });
    if (!res.ok) return;
    const d = await res.json();
    const s = d.spark || {}, l = d.linux || {};
    const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    set('orch-spark-cpu',    s.cpu_pct  != null ? s.cpu_pct+'%' : '--%');
    set('orch-spark-gpu',    s.gpu_pct  != null ? s.gpu_pct+'%' : '--%');
    set('orch-spark-vram',   s.vram_gb  ?? '--');
    set('orch-spark-temp',   s.cpu_temp != null ? s.cpu_temp+'Â°C' : '--');
    set('orch-spark-uptime', s.uptime   ?? '--');
    set('orch-linux-cpu',    l.cpu_pct  != null ? l.cpu_pct+'%' : '--%');
    set('orch-linux-ram',    l.ram_gb   ?? '--');
    set('orch-linux-temp',   l.cpu_temp != null ? l.cpu_temp+'Â°C' : '--');
    set('orch-linux-uptime', l.uptime   ?? '--');
  } catch (_) {}
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
refreshAnalytics();
pollOrchMetrics();
setInterval(pollOrchMetrics, 10000);
setInterval(refreshAnalytics, 15000);


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  QUEUE POLLING  +  STEP LOG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  let _queuePollTimer   = null;
  let _stepLogRunId     = null;
  let _stepLogPollTimer = null;
  let _stepLogSeenIds   = new Set();

  // â”€â”€ Queue polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startQueuePolling() {
    if (_queuePollTimer) clearInterval(_queuePollTimer);
    pollQueue();
    _queuePollTimer = setInterval(pollQueue, 4000);
  }

  async function pollQueue() {
    try {
      const res = await fetch(`${API}/api/runs/queue`);
      if (!res.ok) return;
      const { queue: items } = await res.json();
      _renderQueue(items);
    } catch(_) {}
  }

  function _renderQueue(items) {
    const el = document.getElementById('oc-queue-list');
    if (!el) return;
    if (!items || items.length === 0) {
      el.innerHTML = '<div class="oc-queue-empty">NO QUEUED RUNS</div>';
      return;
    }
    el.innerHTML = items.map(item => {
      const task    = (item.task || '').substring(0, 55);
      const waitS   = item.wait_s || 0;
      const waitStr = waitS < 60 ? waitS + 's' : Math.floor(waitS / 60) + 'm ' + (waitS % 60) + 's';
      const mode    = ((item.config || {}).orchestrator_mode) || 'langgraph';
      const mc      = mode === 'strands' ? 'strands' : '';
      return `<div class="oc-queue-item">
        <div class="oc-qi-top">
          <div class="oc-qi-pos">${item.queue_position}</div>
          <div class="oc-qi-task" title="${item.task}">${task}</div>
          <div class="oc-qi-mode ${mc}">${mode.toUpperCase()}</div>
        </div>
        <div class="oc-qi-meta">
          <span>WAIT ${waitStr}</span>
          <span>${(item.model || 'auto').toUpperCase()}</span>
        </div>
      </div>`;
    }).join('');
  }

  // â”€â”€ Step log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function watchRunSteps(runId) {
    if (_stepLogRunId === runId) return;
    _stepLogRunId = runId;
    _stepLogSeenIds.clear();

    const label = document.getElementById('oc-step-run-label');
    if (label) label.textContent = 'RUN ' + runId.substring(0, 8).toUpperCase() + 'â€¦';
    const log = document.getElementById('oc-step-log');
    if (log) log.innerHTML = '';

    if (_stepLogPollTimer) clearInterval(_stepLogPollTimer);
    _pollStepLog();
    _stepLogPollTimer = setInterval(async () => {
      await _pollStepLog();
      try {
        const res = await fetch(`${API}/api/runs/` + _stepLogRunId);
        if (res.ok) {
          const d = await res.json();
          if (d.run && ['completed', 'failed', 'cancelled'].includes(d.run.status)) {
            clearInterval(_stepLogPollTimer);
            if (label) label.textContent = 'RUN ' + _stepLogRunId.substring(0, 8).toUpperCase() + ' â€” ' + d.run.status.toUpperCase();
          }
        }
      } catch(_) {}
    }, 2500);
  }

  async function _pollStepLog() {
    if (!_stepLogRunId) return;
    try {
      const res = await fetch(`${API}/api/runs/` + _stepLogRunId);
      if (!res.ok) return;
      const { events } = await res.json();
      if (!events) return;
      const log = document.getElementById('oc-step-log');
      if (!log) return;
      // Remove placeholder if present
      const placeholder = log.querySelector('.oc-step-empty');
      if (placeholder) placeholder.remove();
      let added = 0;
      for (const ev of events) {
        const key = String(ev.id || '') || (ev.event_type + ':' + ev.ts);
        if (_stepLogSeenIds.has(key)) continue;
        _stepLogSeenIds.add(key);
        const el = _makeStepEl(ev);
        if (el) { log.appendChild(el); added++; }
      }
      if (added > 0) log.scrollTop = log.scrollHeight;
      if (log.children.length === 0) {
        log.innerHTML = '<div class="oc-step-empty">WAITING FOR EVENTSâ€¦</div>';
      }
    } catch(_) {}
  }

  function _makeStepEl(ev) {
    const type = ev.event_type || 'raw';
    const data = ev.data || {};
    let text = '';

    switch (type) {
      case 'status':
        text = data.message || 'status';
        break;
      case 'node_update': {
        const agent = (data.active_agent || data.node || '?').toUpperCase();
        const msg   = data.message || '';
        text = `[${agent}] ${msg}`;
        if (data.snippet) text += ' â€” ' + String(data.snippet).substring(0, 80);
        if (data.input_preview) text += ' â† ' + String(data.input_preview).substring(0, 60);
        break;
      }
      case 'text_chunk':
        if (!data.text || !data.text.trim()) return null;
        text = `[${(data.agent || 'bot').toUpperCase()}] ${String(data.text).substring(0, 120)}`;
        break;
      case 'error':
        text = 'âœ— ' + (data.message || 'error');
        break;
      case 'usage':
        text = `TOKENS â†‘${data.tokens_in || 0} â†“${data.tokens_out || 0}`;
        break;
      default:
        return null;
    }

    const div = document.createElement('div');
    div.className = `oc-step-item ${type}`;
    div.textContent = text;
    return div;
  }

  // â”€â”€ Auto-watch when a run is dispatched â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Override _streamRun to also start step watching
  const _origStreamRun = typeof _streamRun === 'function' ? _streamRun : null;

  // Start queue polling on load
  startQueuePolling();

</script>
</body>
</html>
